# CCG 自主决策框架

> **用途**：为 Claude 提供统一的决策流程，明确什么情况下可以自主决策，什么时候必须询问用户

## 概述

CCG 系统中，Claude 作为协调者需要在多个决策点做出判断。本文档整合所有决策逻辑，提供清晰的决策树和状态机。

### 决策机制增强（2026-01-21 更新）

本框架已集成以下增强机制：

1. **决策可追溯性** ([decision_traceability.md](decision_traceability.md))
   - 增强版日志格式（reasoning + rule + context）
   - 决策推理模板（Level 0-3）
   - 规则引用和查询分析

2. **批量决策优化** ([batch_decision_optimization.md](batch_decision_optimization.md))
   - 批量模式检测（≥3个相似决策）
   - 批量处理选项（全部应用/预览/逐个确认）
   - 相似度计算算法

3. **决策冲突解决** ([decision_conflict_resolution.md](decision_conflict_resolution.md))
   - 5级优先级体系（安全性 > 用户指令 > Contract > 超时 > 效率）
   - 冲突检测和解决算法
   - 常见冲突场景和方案

4. **上下文感知决策** ([context_aware_decision.md](context_aware_decision.md))
   - 任务优先级（P0-P3）动态调整
   - 复杂度和风险评估
   - 紧急模式/探索模式/高风险模式

---

## 核心决策原则

### 1. 安全第一原则
- ✅ 只读操作可以自主决策
- ⚠️ 写入操作需要评估风险
- ❌ 涉及需求变更必须询问用户

### 2. 透明原则
- 所有自主决策都要向用户报告
- 重要决策需要说明理由
- 用户随时可以中断或回退

### 3. 渐进原则
- 从保守的策略开始
- 根据成功率调整自主性
- 记录决策历史供学习

---

## 主决策流程图

```
任务开始
    ↓
┌─────────────────────────────────┐
│ 任务类型识别                      │
│ - 纯咨询/分析                     │
│ - 代码改动                        │
│ - 配置变更                        │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 是否涉及代码/配置改动？           │
└─────────────────────────────────┘
    ↓ 否              ↓ 是
自主执行          Git 安全检查
    ↓                  ↓
完成报告        ┌─────────────────┐
                │ 调用 Coder/Gemini│
                └─────────────────┘
                    ↓
                执行结果判断
                    ↓
        ┌──────────┴──────────┐
        ↓                      ↓
      成功                   失败
        ↓                      ↓
    Claude 验收          错误分类决策树
        ↓                      ↓
    Codex 审核            (见下方)
```

---

## 错误处理决策树

### 完整决策流程

```
任务执行失败
    ↓
┌─────────────────────────────────────────┐
│ 第 1 步：错误分类                         │
│ (参考 error_classification.md)          │
└─────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────┐
│ 错误类型？                                │
└─────────────────────────────────────────┘
    ↓
┌────┬────┬────┬────┐
│临时│代码│环境│不可│
│性  │错误│错误│恢复│
└────┴────┴────┴────┘
  ↓    ↓    ↓    ↓

【临时性错误分支】
  ↓
┌─────────────────────┐
│ 检查重试次数         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 重试次数 < 最大值？  │
└─────────────────────┘
  ↓ 是        ↓ 否
自动重试    停止并报告
  ↓
┌─────────────────────┐
│ 计算等待时间         │
│ (指数退避算法)       │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 等待后重试           │
│ (保持 SESSION_ID)    │
└─────────────────────┘
  ↓
重新执行

【代码错误分支】
  ↓
┌─────────────────────┐
│ 错误复杂度评估       │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 简单错误？           │
│ (语法/类型/导入)     │
└─────────────────────┘
  ↓ 是        ↓ 否
测试修复决策  Codex 诊断
  ↓            ↓
(见测试分支)  深度分析

【环境错误分支】
  ↓
┌─────────────────────┐
│ 检查错误类型         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 依赖缺失？           │
└─────────────────────┘
  ↓ 是        ↓ 否
自动安装    提供修复指令
  ↓            ↓
验证安装    等待用户确认

【不可恢复错误分支】
  ↓
┌─────────────────────┐
│ 检查是否可降级       │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 有降级方案？         │
└─────────────────────┘
  ↓ 是        ↓ 否
自动降级    停止并报告
  ↓            ↓
(见降级分支)  人工介入
```

### 测试失败修复决策树

```
测试失败
    ↓
┌─────────────────────┐
│ 检查修复次数         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 修复次数 < 3？       │
└─────────────────────┘
  ↓ 是        ↓ 否
继续修复    停止报告
  ↓
┌─────────────────────┐
│ 置信度评估           │
│ (见置信度矩阵)       │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 置信度等级？         │
└─────────────────────┘
  ↓
┌────┬────┬────┐
│高  │中  │低  │
└────┴────┴────┘
  ↓    ↓    ↓
自动  谨慎  停止
修复  修复  报告
  ↓    ↓
Coder Codex
执行  诊断
```

### 自动降级决策树

```
检测到服务不可用
    ↓
┌─────────────────────┐
│ 识别服务类型         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ Codex 不可用？       │
└─────────────────────┘
  ↓ 是        ↓ 否
降级方案    检查 Gemini
  ↓            ↓
┌─────────────────────┐
│ 审核任务？           │
└─────────────────────┘
  ↓ 是        ↓ 否
使用 Coder  使用 Claude
审核        自审
  ↓            ↓
降低标准    提高谨慎度
  ↓
记录降级事件
  ↓
继续执行

【Gemini 不可用分支】
  ↓
┌─────────────────────┐
│ 任务类型判断         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 前端/UI 任务？       │
└─────────────────────┘
  ↓ 是        ↓ 否
尝试 Codex  使用 Coder
指导        执行
  ↓            ↓
或回退      或 Claude
Claude      亲自动手
```

---

## 重试策略决策矩阵

### 按错误类型

| 错误类型 | 自主重试 | 最大次数 | 退避策略 | SESSION_ID | 用户通知 |
|---------|---------|---------|---------|-----------|---------|
| 网络超时 | ✅ 是 | 3 | 指数退避 | 保持 | 每次重试前 |
| API 限流 | ✅ 是 | 5 | 指数退避 | 保持 | 每次重试前 |
| 服务不可用 | ✅ 是 | 3 | 指数退避 | 保持 | 第 1 次失败时 |
| 语法错误 | ⚠️ 条件 | 1 | - | 新建 | 提供建议后 |
| 类型错误 | ⚠️ 条件 | 1 | - | 新建 | 提供建议后 |
| 测试失败 | ⚠️ 条件 | 3 | 置信度评估 | 保持 | 每次修复前 |
| 依赖缺失 | ✅ 是 | 1 | - | - | 安装前确认 |
| 权限错误 | ❌ 否 | 0 | - | - | 立即报告 |
| 认证失败 | ❌ 否 | 0 | - | - | 立即报告 |

### 按 Agent 类型

| Agent | 默认重试 | 最大次数 | 覆盖配置 | 说明 |
|-------|---------|---------|---------|------|
| Coder | ❌ 否 | 0 | `max_retries=3` | 有写入副作用 |
| Codex | ✅ 是 | 1 | `max_retries=3` | 只读操作 |
| Gemini | ✅ 是 | 1 | `max_retries=3` | 默认允许重试 |
| Claude | - | - | - | 自主判断 |

---

## 超时处理决策

### 任务级超时

```
任务执行中
    ↓
┌─────────────────────┐
│ 监控执行时间         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 超过超时阈值？       │
└─────────────────────┘
  ↓ 否        ↓ 是
继续执行    超时处理
  ↓
┌─────────────────────┐
│ Agent 类型？         │
└─────────────────────┘
  ↓
┌────┬────┬────┐
│Coder│Codex│Gemini│
└────┴────┴────┘
10min 5min 8min
  ↓    ↓    ↓
终止进程并报告
  ↓
┌─────────────────────┐
│ 提供诊断建议         │
└─────────────────────┘
```

### 决策级超时（防止 Claude 陷入循环）

| 异常行为 | 阈值 | 触发动作 |
|---------|------|---------|
| 连续读取同一文件 | 5 次 | 警告"可能陷入循环" |
| 连续工具调用失败 | 3 次 | 强制停止并询问用户 |
| 长时间无进展 | 10 分钟 | 建议用户重新描述需求 |
| 过度搜索 | 20 次 Grep/Glob | 建议缩小搜索范围 |

---

## Contract vs Code 修复决策

> 参考：`failure_loop_decision.md`

```
Codex 审核 Blocking
    ↓
┌─────────────────────────────────┐
│ 分析 Blocking 原因                │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 原因归属判断                      │
└─────────────────────────────────┘
  ↓
┌────────────┬────────────┐
│ 代码问题    │ Contract 问题│
└────────────┴────────────┘
  ↓              ↓

【修复代码】        【修复 Contract】
- 超出 Scope        - 需求矛盾
- 违反约束          - 新约束发现
- 缺少测试          - Scope 合理变更
- 性能不达标        - 性能判断错误
  ↓                  ↓
委托 Coder 修复     更新 Contract
  ↓                  ↓
重新审核            重新执行
```

**决策规则**：
- ✅ 代码违反 Contract → 修复代码
- ✅ Contract 错误/不完整 → 修复 Contract
- ⚠️ 不确定 → 询问用户

---

## 降级策略决策

### Codex 不可用降级

```
Codex API 调用失败
    ↓
┌─────────────────────┐
│ 错误分类             │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ api_quota_exceeded   │
│ 或 auth_failure？    │
└─────────────────────┘
  ↓ 是        ↓ 否
自动降级    重试策略
  ↓
┌─────────────────────┐
│ 降级方案 1：         │
│ 使用 Coder 审核      │
│ (降低标准)           │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ Prompt 调整：        │
│ "快速检查关键问题"   │
└─────────────────────┘
  ↓
执行并记录降级
  ↓
完成后提示用户
```

### Gemini 不可用降级

```
Gemini 调用失败
    ↓
┌─────────────────────┐
│ 任务类型判断         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 前端/UI 任务？       │
└─────────────────────┘
  ↓ 是        ↓ 否
前端降级    通用降级
  ↓            ↓
┌─────────────────────┐
│ 降级方案 1：         │
│ Codex 提供架构指导   │
│ + Coder 执行         │
└─────────────────────┘
  ↓
┌─────────────────────┐
│ 降级方案 2：         │
│ Claude 亲自动手      │
└─────────────────────┘
```

---

## 自主决策检查清单

Claude 在做出自主决策前，应该检查：

### ✅ 可以自主决策的场景

- [ ] 临时性错误重试（≤ 最大次数）
- [ ] 安装缺失的依赖（安全的包管理器）
- [ ] 创建 Git 安全点
- [ ] 简单语法错误的修复建议
- [ ] 代码格式化和 lint 修复
- [ ] 自动化测试执行
- [ ] 服务降级（有明确降级方案）
- [ ] 文件搜索和代码分析

### ⚠️ 需要向用户报告但可继续的场景

- [ ] 第 1 次测试失败修复
- [ ] API 服务降级
- [ ] 超出预期的执行时间
- [ ] 发现新的风险或约束
- [ ] Contract 可能需要调整

### ❌ 必须询问用户的场景

- [ ] 修改 Contract Scope
- [ ] 执行不可逆操作（删除文件/数据库）
- [ ] 修改认证/权限配置
- [ ] 安装不在 requirements.txt 的依赖
- [ ] 超过 3 次测试修复失败
- [ ] 不确定如何解决的问题
- [ ] 用户明确要求人工确认的操作

---

## 状态机模型

### 任务执行状态机

```
[待开始] → [执行中] → [成功] → [验收中] → [审核中] → [完成]
              ↓          ↓         ↓          ↓
           [失败] → [分类] → [重试] → [执行中]
              ↓          ↓
           [修复] → [执行中]
              ↓
           [人工介入]
```

### 状态转换规则

| 当前状态 | 触发事件 | 自主决策 | 下一状态 |
|---------|---------|---------|---------|
| 执行中 | 成功完成 | ✅ 是 | 验收中 |
| 执行中 | 失败 | ✅ 是 | 分类 |
| 分类 | 临时性错误 | ✅ 是 | 重试 |
| 分类 | 代码错误 | ⚠️ 条件 | 修复 |
| 分类 | 环境错误 | ⚠️ 条件 | 修复 |
| 分类 | 不可恢复 | ❌ 否 | 人工介入 |
| 重试 | 次数 < 最大 | ✅ 是 | 执行中 |
| 重试 | 次数 = 最大 | ❌ 否 | 人工介入 |
| 修复 | 置信度高 | ✅ 是 | 执行中 |
| 修复 | 置信度低 | ❌ 否 | 人工介入 |
| 验收中 | 通过 | ✅ 是 | 审核中 |
| 验收中 | 不通过 | ✅ 是 | 修复 |
| 审核中 | 通过 | ✅ 是 | 完成 |
| 审核中 | Blocking | ⚠️ 条件 | 修复 |

---

## 决策日志记录

所有重要决策应该记录到 `.ccg/decision_log.jsonl`：

```jsonl
{"timestamp": "2026-01-21T14:00:00Z", "decision": "auto_retry", "reason": "network_timeout", "attempt": 1, "max": 3}
{"timestamp": "2026-01-21T14:00:05Z", "decision": "auto_retry", "reason": "network_timeout", "attempt": 2, "max": 3}
{"timestamp": "2026-01-21T14:00:12Z", "decision": "success", "retry_count": 2}
{"timestamp": "2026-01-21T14:05:00Z", "decision": "auto_fix", "reason": "test_failure", "confidence": "high"}
{"timestamp": "2026-01-21T14:10:00Z", "decision": "ask_user", "reason": "low_confidence", "context": "repeated test failures"}
```

---

## 使用指南

### 对于 Claude

1. **每次决策点参考本文档**
2. **优先使用决策树**：按图索骥，避免主观判断
3. **记录重要决策**：写入 decision_log.jsonl
4. **向用户透明**：说明决策理由和后续动作

### 对于用户

1. **信任自动化**：临时性错误重试是安全的
2. **监控报告**：Claude 会在关键点报告
3. **随时中断**：发现问题可以立即停止
4. **查看日志**：`.ccg/decision_log.jsonl` 记录所有决策

---

## 相关文档

- **错误分类**：`error-handling/error_classification.md`
- **重试策略**：`error-handling/retry_strategy.md`
- **恢复建议**：`error-handling/recovery_suggestions.md`
- **决策权限**：`decision_authority_matrix.md`（本次新建）
- **超时机制**：`timeout_guardrails.md`（本次新建）
- **测试修复**：`testing/test_failure_auto_fix.md`
- **降级策略**：`error-handling/auto_degradation.md`（本次新建）

---

## 快速参考

### 常见决策场景

| 场景 | 决策 | 依据 |
|------|------|------|
| 网络超时，第 1 次 | ✅ 自动重试 | 临时性错误，重试 < 3 |
| 网络超时，第 4 次 | ❌ 停止报告 | 超过最大重试次数 |
| 语法错误 | ⚠️ 建议修复 | 代码错误，需分析 |
| 测试失败，置信度高 | ✅ 自动修复 | 修复次数 < 3 |
| 测试失败，置信度低 | ❌ 询问用户 | 避免无效尝试 |
| Codex API 额度不足 | ✅ 自动降级 | 有降级方案 |
| 需要安装 pandas | ✅ 提示后安装 | 安全操作 |
| 需要修改 Contract | ❌ 询问用户 | 涉及需求变更 |
