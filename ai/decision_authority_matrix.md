# CCG 决策权限矩阵

> **用途**：明确定义 Claude 在各种场景下的决策权限，避免过度保守或过度自主

## 概述

本文档定义了 Claude 在 CCG 系统中的决策边界，回答核心问题：
- ✅ **什么情况下可以自主决策？**
- ⚠️ **什么情况下需要报告但可继续？**
- ❌ **什么情况下必须询问用户？**

---

## 决策权限等级

### Level 0：完全自主 ✅
- **定义**：Claude 可以直接执行，无需询问或报告
- **特征**：无风险、可逆、用户预期的操作
- **执行**：静默执行，仅在完成后报告

### Level 1：透明自主 🔵
- **定义**：Claude 可以自主决策，但需要向用户报告
- **特征**：低风险、可逆、但用户应该知道
- **执行**：先报告决策和理由，然后执行

### Level 2：提示确认 ⚠️
- **定义**：Claude 提供建议，等待用户确认后执行
- **特征**：中等风险、可能影响用户意图
- **执行**：提供选项和建议，等待用户选择

### Level 3：强制询问 ❌
- **定义**：必须询问用户，不能自主决策
- **特征**：高风险、不可逆、涉及需求变更
- **执行**：详细说明情况，等待明确指令

---

## 场景权限矩阵

### 1. 错误处理和重试

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 网络超时（第 1-3 次） | ✅ Level 0 | 重试 ≤ 3 次 | 自动重试，指数退避 |
| 网络超时（第 4 次） | ❌ Level 3 | 超过最大次数 | 报告失败，询问是否继续 |
| API 限流（第 1-5 次） | 🔵 Level 1 | 重试 ≤ 5 次 | 报告限流，自动重试 |
| API 限流（第 6 次） | ❌ Level 3 | 超过最大次数 | 建议稍后重试或更换 API |
| 服务临时不可用 | 🔵 Level 1 | 重试 ≤ 3 次 | 报告情况，自动重试 |
| 认证失败 | ❌ Level 3 | 不可恢复 | 立即停止，要求用户检查配置 |
| 权限不足 | ❌ Level 3 | 不可恢复 | 立即停止，提供修复指令 |

### 2. 代码错误修复

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 简单语法错误（缺括号） | ⚠️ Level 2 | 明确的错误 | 提供修复建议，询问是否自动修复 |
| 类型错误（明显） | ⚠️ Level 2 | 错误信息清晰 | 分析原因，建议修复方案 |
| 导入错误（模块拼写） | ⚠️ Level 2 | 可以推断正确名称 | 建议正确的导入语句 |
| 逻辑错误 | ❌ Level 3 | 涉及业务逻辑 | 分析问题，询问预期行为 |
| 复杂重构需求 | ❌ Level 3 | 影响架构 | 提供方案，等待确认 |

### 3. 测试失败处理

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 测试失败（第 1 次，高置信度） | 🔵 Level 1 | 置信度 ≥ 0.8 | 报告失败，自动修复 |
| 测试失败（第 1 次，中置信度） | ⚠️ Level 2 | 0.5 ≤ 置信度 < 0.8 | 分析原因，建议修复 |
| 测试失败（第 1 次，低置信度） | ❌ Level 3 | 置信度 < 0.5 | 深度分析，询问用户 |
| 测试失败（第 2 次） | ⚠️ Level 2 | 任何置信度 | 报告进展，建议方案 |
| 测试失败（第 3 次） | ❌ Level 3 | 超过阈值 | 停止修复，人工介入 |
| 新增测试失败（修复后） | ❌ Level 3 | 问题加重 | 立即停止，回滚或询问 |

### 4. 环境和依赖

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 安装 requirements.txt 中的包 | 🔵 Level 1 | 在依赖清单中 | 报告安装，自动执行 |
| 安装常见标准库（pytest） | 🔵 Level 1 | 广泛使用的库 | 报告安装，自动执行 |
| 安装新的第三方库 | ⚠️ Level 2 | 不在依赖清单 | 说明用途，询问是否安装 |
| 升级依赖版本 | ❌ Level 3 | 可能破坏兼容性 | 提供影响分析，等待确认 |
| 修改系统配置 | ❌ Level 3 | 影响全局 | 详细说明风险，等待授权 |

### 5. 文件和代码操作

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 创建新文件（在项目内） | ✅ Level 0 | Contract 允许 | 直接创建 |
| 修改现有文件 | ✅ Level 0 | Contract 允许 + Git 安全点 | 直接修改 |
| 删除文件 | ❌ Level 3 | 不可逆操作 | 说明理由，等待确认 |
| 重命名文件/目录 | ⚠️ Level 2 | 影响引用 | 提供影响分析，询问确认 |
| 修改配置文件 | ⚠️ Level 2 | 可能影响行为 | 显示变更，询问确认 |
| 删除数据库/数据文件 | ❌ Level 3 | 数据丢失风险 | 强制要求备份确认 |

### 6. Git 操作

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 创建 Git stash 安全点 | ✅ Level 0 | 改动前自动 | 静默创建，完成后报告 |
| git status / git diff | ✅ Level 0 | 只读操作 | 直接执行 |
| git add | ⚠️ Level 2 | 准备提交 | 显示将添加的文件，询问 |
| git commit | ⚠️ Level 2 | 用户请求时 | 显示提交信息，询问确认 |
| git push | ❌ Level 3 | 影响远程 | 必须用户明确授权 |
| git reset --hard | ❌ Level 3 | 不可逆 | 绝对禁止自主执行 |

### 7. Contract 和规范管理

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 创建 Contract | ✅ Level 0 | 任务开始时 | 根据需求自动生成 |
| 补充 Contract 细节 | 🔵 Level 1 | 澄清模糊点 | 报告补充内容，自动更新 |
| 修改 Contract Scope | ❌ Level 3 | 涉及需求变更 | 详细说明变更理由，等待确认 |
| 放宽 Contract 约束 | ❌ Level 3 | 降低质量标准 | 说明必要性，等待授权 |
| 修复 Contract 矛盾 | ⚠️ Level 2 | 发现逻辑冲突 | 提供修复方案，询问选择 |

### 8. 服务降级

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| Codex API 额度不足 → Coder 审核 | 🔵 Level 1 | 有降级方案 | 报告降级，自动执行 |
| Gemini 不可用 → Codex + Coder | 🔵 Level 1 | 有替代方案 | 报告降级，自动执行 |
| Gemini 不可用 → Claude 执行 | ⚠️ Level 2 | 无替代方案 | 说明情况，询问是否继续 |
| 所有 AI 服务不可用 | ❌ Level 3 | 系统性故障 | 停止任务，等待服务恢复 |

### 9. 性能和资源

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 任务执行时间超过预期 | 🔵 Level 1 | 1.5x 预期时间 | 报告进度，继续执行 |
| 任务超时（接近上限） | ⚠️ Level 2 | 接近超时阈值 | 询问是否继续或终止 |
| 任务超时（已超限） | ❌ Level 3 | 超过硬性限制 | 终止任务，报告原因 |
| 大量文件操作（> 100） | ⚠️ Level 2 | 资源密集 | 报告操作量，询问确认 |
| 过度搜索（> 20 次） | ⚠️ Level 2 | 可能陷入循环 | 建议缩小范围或重新描述 |

### 10. 用户交互

| 场景 | 权限等级 | 条件 | 示例 |
|------|---------|------|------|
| 需求不明确 | ❌ Level 3 | 无法推断意图 | 列出可能的理解，询问确认 |
| 多个可行方案 | ⚠️ Level 2 | 无明显最优 | 提供方案对比，询问选择 |
| 技术选型决策 | ❌ Level 3 | 影响长期 | 提供分析，等待决定 |
| 风险权衡 | ❌ Level 3 | 涉及取舍 | 详细说明利弊，让用户决定 |

---

## 决策流程指南

### Claude 如何使用权限矩阵

```
遇到决策点
    ↓
1. 在矩阵中查找匹配场景
    ↓
2. 确定权限等级
    ↓
3. 根据等级执行对应流程
    ↓
┌────┬────┬────┬────┐
│L0  │L1  │L2  │L3  │
└────┴────┴────┴────┘
  ↓    ↓    ↓    ↓
直接  报告  提示  询问
执行  执行  确认  用户
```

### Level 0 执行模板

```
直接执行操作
    ↓
完成后简要报告
```

**示例**：
```
✅ 已创建 Git 安全点 stash@{0}
✅ 已修改 src/main.py（新增登录功能）
```

### Level 1 执行模板

```
向用户报告：
  - 即将执行的操作
  - 执行理由
  - 预期结果
    ↓
执行操作
    ↓
报告执行结果
```

**示例**：
```
🔵 检测到 API 限流错误（429 Too Many Requests）
→ 将在 4 秒后自动重试（第 2/5 次）
→ 使用指数退避策略，避免过度请求

... 4 秒后 ...

✅ 重试成功，任务继续执行
```

### Level 2 执行模板

```
向用户说明情况：
  - 当前问题/需求
  - 可选方案及优劣
  - 推荐方案及理由
    ↓
询问用户选择
    ↓
等待用户响应
    ↓
按用户选择执行
```

**示例**：
```
⚠️ 测试失败分析：

**问题**：test_login() 失败，错误信息为 "KeyError: 'username'"

**可能原因**：
1. 输入数据缺少 'username' 字段
2. 代码逻辑未检查字段存在性

**建议方案**：
- 方案 A：添加输入验证（推荐）
- 方案 B：修改测试数据

**置信度**：中等（0.6）

是否允许我使用方案 A 自动修复？或者您希望采用其他方案？
```

### Level 3 执行模板

```
详细说明情况：
  - 问题描述
  - 风险分析
  - 可能的影响
  - 需要用户决定的原因
    ↓
明确询问用户意图
    ↓
等待明确授权
    ↓
严格按用户指令执行
```

**示例**：
```
❌ 需要您的决策：

**情况**：测试已失败 3 次，每次错误不同

**修复历史**：
- 第 1 次：修复语法错误 → 新的类型错误
- 第 2 次：修复类型错误 → 新的逻辑错误
- 第 3 次：修复逻辑错误 → 其他测试失败

**风险分析**：
- 问题可能比预期复杂
- 继续自动修复可能引入更多问题
- 可能需要重新审视 Contract 或实现方案

**建议**：
1. 停止自动修复，由您人工介入
2. 或者重新与 Codex 沟通设计方案
3. 或者调整 Contract，降低复杂度

请告诉我您希望采取哪种方式？
```

---

## 特殊场景决策

### 场景 1：不确定权限等级时

**原则**：**向更严格的等级靠拢**

```
如果犹豫场景是 Level 1 还是 Level 2
  → 选择 Level 2（提示确认）

如果犹豫场景是 Level 2 还是 Level 3
  → 选择 Level 3（强制询问）
```

**理由**：保守策略更安全，用户可以要求放宽

### 场景 2：用户明确授权"自由发挥"

**处理**：
- 仍然遵守 Level 3 的强制询问
- 可以将 Level 2 提升到 Level 1
- Level 1 可以提升到 Level 0

**示例**：
```
用户："随便改，不用问我"
  ↓
Claude：
  - Level 0: 直接执行 ✅
  - Level 1: 直接执行（报告即可）✅
  - Level 2: 直接执行（事后报告）✅
  - Level 3: 仍然询问 ⚠️（涉及不可逆操作）
```

### 场景 3：紧急情况（系统故障）

**处理**：
- 可以临时提升权限等级
- 必须在事后详细报告
- 记录到决策日志

**示例**：
```
检测到服务完全不可用
  ↓
正常：Level 3（询问用户）
紧急：Level 1（报告后降级）
  ↓
执行降级
  ↓
详细报告：
  - 紧急情况描述
  - 采取的行动
  - 临时提升权限的理由
```

### 场景 4：批量操作

**原则**：**首次询问，后续批量执行**

```
遇到批量重复操作
  ↓
第 1 次：按正常权限等级处理
  ↓
用户确认后
  ↓
后续类似操作：自动执行（报告总数）
```

**示例**：
```
需要修复 15 个文件的相同语法错误
  ↓
第 1 个文件：Level 2（询问确认）
  ↓
用户："可以，批量修复吧"
  ↓
后续 14 个文件：Level 1（报告进度）
  ↓
最终报告：已修复 15 个文件
```

---

## 权限矩阵更新机制

### 用户可以自定义权限

通过 `.ccg/user_preferences.json` 调整：

```json
{
  "decision_authority": {
    "auto_retry_network": "level_0",  // 默认 level_0，用户可改为 level_1
    "auto_fix_syntax": "level_2",     // 默认 level_2，用户可改为 level_1
    "auto_install_deps": "level_1",   // 默认 level_1，用户可改为 level_2
    "auto_git_commit": "level_3"      // 默认 level_2，用户强制改为 level_3
  },
  "global_strictness": "normal"       // normal | strict | relaxed
}
```

### 全局严格模式

| 模式 | 说明 | 效果 |
|------|------|------|
| `strict` | 严格模式 | 所有 Level 2 → Level 3 |
| `normal` | 正常模式 | 使用默认权限矩阵 |
| `relaxed` | 宽松模式 | Level 2 → Level 1，Level 1 → Level 0 |

---

## 决策日志格式

所有 Level 1+ 的决策应该记录：

```jsonl
{"timestamp": "2026-01-21T14:00:00Z", "level": "level_1", "scenario": "auto_retry", "action": "retry_network_timeout", "attempt": 1}
{"timestamp": "2026-01-21T14:05:00Z", "level": "level_2", "scenario": "test_failure", "action": "suggest_fix", "confidence": 0.7, "user_response": "approved"}
{"timestamp": "2026-01-21T14:10:00Z", "level": "level_3", "scenario": "contract_scope_change", "action": "ask_user", "user_response": "modify_contract"}
```

---

## 相关文档

- **决策框架**：`decision_framework.md`（总体流程）
- **错误分类**：`error-handling/error_classification.md`
- **重试策略**：`error-handling/retry_strategy.md`
- **超时机制**：`timeout_guardrails.md`（本次新建）
- **测试修复**：`testing/test_failure_auto_fix.md`

---

## 快速参考卡

### Claude 决策速查

```
遇到决策点 → 查找场景 → 确定等级 → 执行流程

✅ Level 0：直接执行
🔵 Level 1：报告 + 执行
⚠️ Level 2：建议 + 询问
❌ Level 3：强制询问

不确定？→ 选更严格的等级
```

### 用户快速配置

```bash
# 查看当前权限配置
cat .ccg/user_preferences.json

# 设置严格模式
echo '{"global_strictness": "strict"}' > .ccg/user_preferences.json

# 设置宽松模式
echo '{"global_strictness": "relaxed"}' > .ccg/user_preferences.json
```
