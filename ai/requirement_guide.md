# 需求文档编写指南

> **目标**：帮助用户编写清晰、可执行的需求文档，确保 Claude 能够准确理解并拆解任务。

---

## 一、需求文档的重要性

### 1.1 为什么需要好的需求文档？

**好的需求文档能够**：
- ✅ 让 Claude 准确理解您的意图
- ✅ 减少来回沟通的次数
- ✅ 提高 Coder 执行的准确性
- ✅ 降低 Codex 审核的返工率
- ✅ 加快整体开发速度

**不好的需求文档会导致**：
- ❌ Claude 频繁询问细节
- ❌ Coder 实现偏离预期
- ❌ Codex 审核发现大量问题
- ❌ 需要多次返工和修改

---

## 二、需求文档的基本结构

### 2.1 必需的核心要素

一个完整的需求文档应包含以下要素：

| 要素 | 说明 | 是否必需 |
|------|------|---------|
| **功能描述** | 要实现什么功能 | ✅ 必需 |
| **使用场景** | 在什么情况下使用 | ✅ 必需 |
| **输入输出** | 输入什么，输出什么 | ✅ 必需 |
| **验收标准** | 如何判断功能完成 | ✅ 必需 |
| **技术约束** | 使用什么技术栈 | ⚠️ 推荐 |
| **性能要求** | 响应时间、并发量等 | ⚠️ 推荐 |
| **边界条件** | 异常情况如何处理 | ⚠️ 推荐 |
| **UI/UX 要求** | 界面设计要求 | 🔵 可选 |

### 2.2 推荐的文档模板

```markdown
# 需求标题

## 1. 功能描述
[用 1-3 句话描述要实现的功能]

## 2. 使用场景
[描述用户在什么情况下会使用这个功能]

## 3. 功能详细说明

### 3.1 输入
- 输入项 1：[类型、格式、约束]
- 输入项 2：[类型、格式、约束]

### 3.2 处理逻辑
1. 步骤 1：[描述]
2. 步骤 2：[描述]
3. 步骤 3：[描述]

### 3.3 输出
- 输出项 1：[类型、格式]
- 输出项 2：[类型、格式]

## 4. 验收标准
- [ ] 标准 1：[可验证的标准]
- [ ] 标准 2：[可验证的标准]
- [ ] 标准 3：[可验证的标准]

## 5. 技术约束（可选）
- 编程语言：[Python/Java/JavaScript]
- 框架：[Django/Spring Boot/React]
- 数据库：[PostgreSQL/MySQL/MongoDB]

## 6. 性能要求（可选）
- 响应时间：< 200ms
- 并发量：1000 QPS
- 数据量：支持 100 万条记录

## 7. 边界条件（可选）
- 异常情况 1：[如何处理]
- 异常情况 2：[如何处理]
```

---

## 三、需求文档案例

### 案例 1：用户认证功能（完整示例）

```markdown
# 用户认证功能

## 1. 功能描述
实现基于 JWT 的用户登录和注册功能，支持邮箱密码登录，返回 JWT token 用于后续 API 调用。

## 2. 使用场景
- 新用户首次访问系统时，需要注册账号
- 已注册用户访问系统时，需要登录获取 token
- 用户在其他 API 调用时，需要携带 token 进行身份验证

## 3. 功能详细说明

### 3.1 注册接口

**输入**：
- 邮箱：字符串，必须符合邮箱格式，唯一
- 密码：字符串，长度 8-32 位，必须包含字母和数字
- 用户名：字符串，长度 2-20 位，可选

**处理逻辑**：
1. 验证邮箱格式和唯一性
2. 验证密码强度
3. 使用 bcrypt 加密密码
4. 保存用户信息到数据库
5. 返回用户 ID 和基本信息

**输出**：
```json
{
  "success": true,
  "data": {
    "user_id": "uuid",
    "email": "user@example.com",
    "username": "张三",
    "created_at": "2026-01-17T10:00:00Z"
  }
}
```

### 3.2 登录接口

**输入**：
- 邮箱：字符串
- 密码：字符串

**处理逻辑**：
1. 查询用户是否存在
2. 验证密码是否正确
3. 生成 JWT token（有效期 7 天）
4. 返回 token 和用户信息

**输出**：
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "user_id": "uuid",
      "email": "user@example.com",
      "username": "张三"
    },
    "expires_at": "2026-01-24T10:00:00Z"
  }
}
```

## 4. 验收标准
- [ ] 注册接口：邮箱格式验证正确
- [ ] 注册接口：密码强度验证正确
- [ ] 注册接口：重复邮箱返回 409 错误
- [ ] 登录接口：正确的邮箱密码返回 token
- [ ] 登录接口：错误的密码返回 401 错误
- [ ] 登录接口：不存在的邮箱返回 404 错误
- [ ] JWT token 包含 user_id 和 email
- [ ] JWT token 有效期为 7 天
- [ ] 单元测试覆盖率 ≥ 90%
- [ ] 集成测试覆盖所有成功和失败路径

## 5. 技术约束
- 编程语言：Python 3.11
- 框架：FastAPI
- 数据库：PostgreSQL
- JWT 库：PyJWT
- 密码加密：bcrypt

## 6. 性能要求
- 注册接口响应时间：< 500ms
- 登录接口响应时间：< 200ms
- 并发量：支持 100 QPS

## 7. 边界条件
- 邮箱格式错误：返回 400 错误，提示"邮箱格式不正确"
- 密码强度不足：返回 400 错误，提示"密码必须包含字母和数字，长度 8-32 位"
- 邮箱已存在：返回 409 错误，提示"该邮箱已被注册"
- 登录密码错误：返回 401 错误，提示"邮箱或密码错误"
- 用户不存在：返回 404 错误，提示"用户不存在"
- 数据库连接失败：返回 503 错误，提示"服务暂时不可用"
```

---

### 案例 2：数据导出功能（中等复杂度）

```markdown
# 用户数据导出功能

## 1. 功能描述
允许管理员导出用户数据为 CSV 或 Excel 格式，支持按时间范围和用户状态筛选。

## 2. 使用场景
- 管理员需要生成月度用户报表
- 管理员需要导出特定时间段的活跃用户数据
- 管理员需要导出已注销用户的数据用于审计

## 3. 功能详细说明

### 3.1 输入
- 导出格式：枚举（csv / excel），必需
- 开始时间：日期时间，可选
- 结束时间：日期时间，可选
- 用户状态：枚举（active / inactive / deleted），可选

### 3.2 处理逻辑
1. 验证管理员权限
2. 根据筛选条件查询用户数据
3. 生成 CSV 或 Excel 文件
4. 返回文件下载链接（有效期 1 小时）

### 3.3 输出
```json
{
  "success": true,
  "data": {
    "download_url": "https://example.com/exports/users_20260117.csv",
    "expires_at": "2026-01-17T11:00:00Z",
    "total_records": 1523
  }
}
```

## 4. 验收标准
- [ ] 支持 CSV 和 Excel 两种格式
- [ ] 时间范围筛选正确
- [ ] 用户状态筛选正确
- [ ] 导出文件包含所有必要字段（ID、邮箱、用户名、注册时间、状态）
- [ ] 非管理员访问返回 403 错误
- [ ] 下载链接 1 小时后失效
- [ ] 单元测试覆盖率 ≥ 80%

## 5. 技术约束
- 编程语言：Python 3.11
- 框架：Django
- 导出库：pandas（CSV）、openpyxl（Excel）
- 文件存储：AWS S3

## 6. 性能要求
- 导出 1 万条记录：< 5 秒
- 导出 10 万条记录：< 30 秒
- 支持最大 100 万条记录

## 7. 边界条件
- 无权限访问：返回 403 错误
- 时间范围无效：返回 400 错误
- 数据量超过 100 万：返回 400 错误，提示"数据量过大，请缩小时间范围"
```

---

### 案例 3：Bug 修复（简单示例）

```markdown
# 修复用户头像上传失败的问题

## 1. 问题描述
用户上传头像时，如果文件大小超过 2MB，系统返回 500 错误而不是 400 错误。

## 2. 当前行为
- 上传 < 2MB 的图片：成功
- 上传 > 2MB 的图片：返回 500 错误，日志显示"Internal Server Error"

## 3. 期望行为
- 上传 < 2MB 的图片：成功
- 上传 > 2MB 的图片：返回 400 错误，提示"文件大小不能超过 2MB"

## 4. 验收标准
- [ ] 上传 > 2MB 的图片返回 400 错误
- [ ] 错误信息为"文件大小不能超过 2MB"
- [ ] 不再出现 500 错误
- [ ] 添加单元测试验证文件大小检查

## 5. 技术约束
- 文件位置：`src/api/user/avatar.py`
- 相关函数：`upload_avatar()`

## 6. 边界条件
- 文件大小刚好 2MB：应该成功
- 文件大小 2MB + 1 字节：应该返回 400 错误
```

---

### 案例 4：性能优化（中等复杂度）

```markdown
# 优化用户列表查询性能

## 1. 问题描述
用户列表页面加载缓慢，当用户数量超过 10 万时，查询时间超过 5 秒。

## 2. 当前性能
- 1 万用户：200ms
- 10 万用户：5 秒
- 100 万用户：超时（> 30 秒）

## 3. 性能目标
- 1 万用户：< 100ms
- 10 万用户：< 500ms
- 100 万用户：< 2 秒

## 4. 优化方案（建议）
- 添加数据库索引（email、created_at）
- 实现分页查询（每页 20 条）
- 添加 Redis 缓存（缓存 5 分钟）
- 优化 SQL 查询（避免 N+1 问题）

## 5. 验收标准
- [ ] 10 万用户查询时间 < 500ms
- [ ] 100 万用户查询时间 < 2 秒
- [ ] 添加性能测试验证
- [ ] 不影响现有功能
- [ ] 缓存失效机制正确

## 6. 技术约束
- 数据库：PostgreSQL
- 缓存：Redis
- ORM：SQLAlchemy

## 7. 边界条件
- 缓存失效时：查询数据库并更新缓存
- Redis 不可用时：降级到直接查询数据库
- 数据库连接失败：返回 503 错误
```

---

## 四、不同类型需求的模板

### 4.1 新功能开发

**最小必需信息**：
```markdown
# [功能名称]

## 功能描述
[1-3 句话描述功能]

## 输入输出
- 输入：[列出所有输入项]
- 输出：[列出所有输出项]

## 验收标准
- [ ] [可验证的标准 1]
- [ ] [可验证的标准 2]
```

### 4.2 Bug 修复

**最小必需信息**：
```markdown
# [Bug 标题]

## 当前行为
[描述当前的错误行为]

## 期望行为
[描述正确的行为]

## 复现步骤
1. [步骤 1]
2. [步骤 2]
3. [步骤 3]

## 验收标准
- [ ] Bug 已修复
- [ ] 添加测试防止回归
```

### 4.3 性能优化

**最小必需信息**：
```markdown
# [优化标题]

## 当前性能
[描述当前的性能指标]

## 性能目标
[描述期望的性能指标]

## 验收标准
- [ ] 性能达到目标
- [ ] 添加性能测试
- [ ] 不影响现有功能
```

### 4.4 重构

**最小必需信息**：
```markdown
# [重构标题]

## 重构原因
[为什么需要重构]

## 重构范围
[哪些文件/模块需要重构]

## 重构目标
[重构后要达到什么效果]

## 验收标准
- [ ] 代码结构更清晰
- [ ] 所有测试通过
- [ ] 不改变外部行为
```

---

## 五、需求文档的质量标准

### 5.1 好的需求文档特征

✅ **清晰明确**：
- 使用简单直白的语言
- 避免模糊的词汇（如"可能"、"大概"、"差不多"）
- 每个要求都是可验证的

✅ **完整详细**：
- 包含所有必要的输入输出
- 列出所有边界条件
- 提供具体的验收标准

✅ **结构化**：
- 使用标题和列表组织内容
- 逻辑清晰，易于阅读
- 重点突出

✅ **可执行**：
- Claude 能够直接理解并拆解
- Coder 能够直接实现
- Codex 能够直接验证

### 5.2 不好的需求文档特征

❌ **模糊不清**：
- "实现一个用户系统"（太宽泛）
- "优化性能"（没有具体目标）
- "修复 Bug"（没有描述问题）

❌ **缺少细节**：
- 没有输入输出说明
- 没有验收标准
- 没有边界条件

❌ **难以验证**：
- "界面要好看"（主观）
- "性能要快"（没有具体指标）
- "代码要优雅"（难以量化）

---

## 六、需求文档检查清单

在提交需求文档前，请检查以下项目：

### 6.1 基本要素检查

- [ ] **功能描述**：是否清晰描述了要实现的功能？
- [ ] **使用场景**：是否说明了在什么情况下使用？
- [ ] **输入输出**：是否列出了所有输入和输出？
- [ ] **验收标准**：是否提供了可验证的标准？

### 6.2 质量检查

- [ ] **清晰度**：是否使用了简单直白的语言？
- [ ] **完整性**：是否包含了所有必要的信息？
- [ ] **可执行性**：Claude 是否能够直接理解并拆解？
- [ ] **可验证性**：是否所有要求都是可验证的？

### 6.3 技术检查

- [ ] **技术栈**：是否说明了使用的技术栈？
- [ ] **性能要求**：是否提供了性能指标（如需要）？
- [ ] **边界条件**：是否列出了异常情况的处理方式？

---

## 七、常见问题

### Q1: 我不知道技术细节，怎么写需求文档？

**答**：没关系！您只需要描述：
- 要实现什么功能
- 输入什么，输出什么
- 如何判断功能完成

技术细节可以由 Claude 和 Codex 来决定。

**示例**：
```markdown
# 用户登录功能

## 功能描述
用户输入邮箱和密码，系统验证后返回登录凭证。

## 输入输出
- 输入：邮箱、密码
- 输出：登录凭证（用于后续 API 调用）

## 验收标准
- [ ] 正确的邮箱密码能够登录成功
- [ ] 错误的密码返回错误提示
- [ ] 不存在的邮箱返回错误提示
```

### Q2: 需求文档需要多详细？

**答**：取决于任务的复杂度：
- **简单任务**（如 Bug 修复）：只需要描述问题和期望行为
- **中等任务**（如新增接口）：需要输入输出和验收标准
- **复杂任务**（如新模块）：需要完整的文档，包括技术约束和性能要求

**原则**：提供足够的信息让 Claude 能够理解并拆解任务。

### Q3: 我可以用自然语言描述需求吗？

**答**：可以！但建议遵循以下原则：
- 使用清晰的结构（标题、列表）
- 提供具体的例子
- 说明验收标准

**示例**：
```markdown
我需要一个用户登录功能。用户输入邮箱和密码，如果正确就返回一个 token，
如果错误就提示"邮箱或密码错误"。token 要能用于后续的 API 调用。

验收标准：
- 正确的邮箱密码能登录成功
- 错误的密码返回错误提示
- token 有效期 7 天
```

---

## 八、总结

### 8.1 核心要点

1. **清晰明确**：使用简单直白的语言
2. **完整详细**：包含所有必要的信息
3. **结构化**：使用标题和列表组织内容
4. **可执行**：Claude 能够直接理解并拆解
5. **可验证**：所有要求都是可验证的

### 8.2 快速参考

| 需求类型 | 必需信息 |
|---------|---------|
| **新功能** | 功能描述 + 输入输出 + 验收标准 |
| **Bug 修复** | 当前行为 + 期望行为 + 验收标准 |
| **性能优化** | 当前性能 + 性能目标 + 验收标准 |
| **重构** | 重构原因 + 重构范围 + 验收标准 |

---

**文档版本**: v1.0
**最后更新**: 2026-01-17
**维护者**: CCG Team
