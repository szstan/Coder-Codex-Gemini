# CCG 超时和卡点处理机制

> **用途**：防止任务执行卡死、Claude 陷入循环、资源耗尽等异常情况

## 概述

CCG 系统中可能出现两类超时问题：
1. **任务级超时**：Coder/Codex/Gemini 执行时间过长
2. **决策级超时**：Claude 陷入分析循环或重复操作

本文档定义了检测机制、超时阈值和处理策略。

---

## 任务级超时机制

### 超时阈值定义

| Agent | 默认超时 | 最大超时 | 可配置 | 说明 |
|-------|---------|---------|-------|------|
| **Coder** | 2 分钟 | 10 分钟 | ✅ `timeout=600` | 代码生成任务 |
| **Codex** | 2 分钟 | 5 分钟 | ✅ `timeout=300` | 代码审核任务 |
| **Gemini** | 2 分钟 | 8 分钟 | ✅ `timeout=480` | 专家咨询任务 |
| **Claude 工具** | 2 分钟 | 10 分钟 | - | Bash/Read/Grep 等 |

### 超时检测流程

```
任务开始执行
    ↓
记录开始时间
    ↓
┌─────────────────────────────────┐
│ 监控执行时间                      │
│ (每 10 秒检查一次)                │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 执行时间 > 默认超时？             │
└─────────────────────────────────┘
    ↓ 否              ↓ 是
继续执行          警告阶段
    ↓                  ↓
任务完成        ┌─────────────────┐
                │ 向用户报告：      │
                │ 任务执行时间超预期│
                └─────────────────┘
                    ↓
                ┌─────────────────┐
                │ 继续监控         │
                └─────────────────┘
                    ↓
                ┌─────────────────┐
                │ 执行时间 > 最大？│
                └─────────────────┘
                    ↓ 是
                强制终止
                    ↓
                清理资源
                    ↓
                报告超时错误
```

### 超时处理策略

#### 警告阶段（超过默认超时）

**触发条件**：执行时间 > 默认超时

**Claude 行动**：
```
⚠️ 任务执行时间警告

**任务**：Coder 生成用户认证模块
**已执行**：2 分 15 秒
**默认超时**：2 分钟
**最大超时**：10 分钟

**当前状态**：任务仍在执行中

**您的选择**：
1. 继续等待（最多再等 7 分 45 秒）
2. 立即终止任务
3. 查看执行日志（诊断是否卡住）

请选择：
```

#### 强制终止阶段（超过最大超时）

**触发条件**：执行时间 > 最大超时

**Claude 行动**：
1. 立即终止进程（`kill` 或 `terminate`）
2. 收集最后的输出日志
3. 分析可能的原因
4. 向用户报告

**报告模板**：
```
❌ 任务执行超时（已强制终止）

**任务**：Codex 审核代码质量
**执行时间**：5 分 12 秒
**最大超时**：5 分钟

**终止原因**：超过最大允许执行时间

**最后输出**（最后 20 行）：
[日志内容...]

**可能原因分析**：
1. 代码文件过大（> 5000 行）
2. Codex API 响应缓慢
3. 网络连接不稳定

**建议操作**：
1. 检查网络连接
2. 拆分大文件为多个小任务
3. 稍后重试（避开高峰期）
4. 考虑使用降级方案（Coder 审核）

是否需要我采取其中某项行动？
```

### 超时错误分类

超时后，自动分类错误类型：

| 超时原因 | 错误类型 | 是否重试 | 建议 |
|---------|---------|---------|------|
| 网络慢 | 临时性错误 | ✅ 是（1 次） | 等待网络恢复 |
| API 过载 | 临时性错误 | ✅ 是（1 次） | 稍后重试或降级 |
| 任务太复杂 | 环境错误 | ❌ 否 | 拆分任务 |
| 进程卡死 | 不可恢复 | ❌ 否 | 重启服务 |

---

## 决策级超时机制

### 异常行为检测

Claude 可能陷入的循环模式：

#### 1. 重复读取同一文件

**检测规则**：
```
在 5 分钟内，连续 5 次 Read 同一文件
→ 触发警告
```

**触发动作**：
```
⚠️ 检测到异常行为：重复读取文件

**文件**：src/main.py
**读取次数**：5 次（最近 3 分钟）

**可能原因**：
- 我可能在寻找不存在的信息
- 任务目标不清晰，导致反复确认
- 文件内容复杂，需要多次理解

**自我诊断建议**：
1. 停止读取，向用户明确询问需求
2. 使用 Grep 搜索特定内容（更精准）
3. 请求用户提供更多上下文

我现在将停止读取该文件，等待您的进一步指导。
请告诉我您具体需要我在这个文件中找什么？
```

#### 2. 连续工具调用失败

**检测规则**：
```
连续 3 次调用同一工具失败（相同错误）
→ 触发强制停止
```

**触发动作**：
```
❌ 检测到重复失败：强制停止

**工具**：mcp__ccg__coder
**失败次数**：3 次
**错误类型**：syntax_error（相同错误）

**失败历史**：
1. 第 1 次（14:00）：SyntaxError at line 42
2. 第 2 次（14:03）：SyntaxError at line 42（相同）
3. 第 3 次（14:06）：SyntaxError at line 42（相同）

**问题分析**：
- 修复方案无效，问题未真正解决
- 可能误判了错误原因
- 或者 Prompt 没有清晰传达修复意图

**强制停止原因**：
- 避免无效重试浪费资源
- 需要重新分析根本原因

**建议操作**：
1. 我需要您帮助确认：第 42 行的正确写法应该是什么？
2. 或者，允许我调用 Codex 进行深度诊断
3. 或者，您可以直接修复这个语法错误

请告诉我您希望如何处理？
```

#### 3. 长时间无进展

**检测规则**：
```
10 分钟内没有完成任何子任务
→ 触发进度检查
```

**触发动作**：
```
⚠️ 进度检查：任务执行时间较长

**任务**：实现用户认证系统
**已执行**：12 分钟
**已完成子任务**：0 / 5

**当前状态**：正在分析代码结构（第 3 次读取文件）

**自我检查**：
- 任务可能比预期复杂
- 可能需要拆分为更小的步骤
- 或者需要更多信息才能继续

**建议**：
1. 向您汇报当前进展和遇到的困难
2. 请求简化任务或提供更多上下文
3. 或者先完成部分功能，分阶段实施

我现在将暂停，向您汇报当前情况。

**当前进展**：
- ✅ 已读取现有认证相关文件
- ✅ 已理解现有架构
- ⏸️ 正在设计新的认证流程（遇到架构选择困难）

**困难点**：
不确定应该使用 JWT 还是 Session 方式，两种方案各有优劣。

请问您倾向于哪种认证方式？或者有其他偏好？
```

#### 4. 过度搜索

**检测规则**：
```
10 分钟内执行 > 20 次 Grep 或 Glob
→ 触发搜索优化建议
```

**触发动作**：
```
⚠️ 搜索优化建议

**搜索次数**：23 次 Grep（最近 8 分钟）
**匹配结果**：大部分搜索返回 0 或 1 个结果

**问题分析**：
- 可能使用了过于精确的搜索模式
- 或者要找的内容不存在
- 或者搜索策略需要调整

**建议优化**：
1. 使用更宽泛的搜索词（如搜索 "auth" 而不是 "authenticate_user_with_jwt"）
2. 使用 acemcp 语义搜索（更智能）
3. 或者直接询问您：这些内容在哪个文件中？

**当前搜索目标**：正在寻找现有的用户认证实现

请问：
1. 项目中是否已有用户认证功能？
2. 如果有，大概在哪个目录或文件中？
3. 如果没有，我可以直接开始新建实现。

您能提供一些线索吗？
```

---

## 超时阈值配置

### 全局配置

在 `.ccg/user_preferences.json` 中配置：

```json
{
  "timeouts": {
    "coder_default": 120,      // 秒（2 分钟）
    "coder_max": 600,          // 秒（10 分钟）
    "codex_default": 120,      // 秒（2 分钟）
    "codex_max": 300,          // 秒（5 分钟）
    "gemini_default": 120,     // 秒（2 分钟）
    "gemini_max": 480,         // 秒（8 分钟）
    "claude_tools_default": 120 // 秒（2 分钟）
  },
  "guardrails": {
    "max_same_file_reads": 5,       // 最多重复读取次数
    "max_consecutive_failures": 3,  // 最多连续失败次数
    "no_progress_timeout": 600,     // 无进展超时（秒）
    "max_searches": 20,             // 最多搜索次数（10 分钟内）
    "search_window": 600            // 搜索窗口（秒）
  }
}
```

### 任务级配置覆盖

调用 MCP 工具时显式设置：

```python
# 复杂任务，允许更长时间
mcp__ccg__coder(
    PROMPT="实现复杂的支付系统",
    cd="/path/to/project",
    timeout=600,  # 10 分钟
    max_duration=900  # 最大 15 分钟
)

# 简单审核，缩短超时
mcp__ccg__codex(
    PROMPT="快速检查代码风格",
    cd="/path/to/project",
    timeout=60  # 1 分钟
)
```

---

## 超时恢复策略

### 策略 1：自动重试（临时性超时）

**适用**：网络慢、API 过载导致的超时

```
第 1 次超时
    ↓
等待 30 秒（冷却）
    ↓
重试（延长超时 1.5 倍）
    ↓
第 2 次超时
    ↓
停止，建议降级或稍后重试
```

### 策略 2：任务拆分（复杂任务超时）

**适用**：任务太大、太复杂

```
检测到超时原因：任务复杂
    ↓
分析任务可拆分性
    ↓
向用户建议：
  - 拆分为 3 个子任务
  - 每个子任务预计 5 分钟
    ↓
等待用户确认
    ↓
按子任务逐个执行
```

### 策略 3：降级执行（服务不稳定）

**适用**：API 服务不稳定

```
检测到 Codex 超时（3 次）
    ↓
判断：可能是服务问题
    ↓
自动降级到 Coder 审核
    ↓
降低审核标准
    ↓
继续任务
```

---

## 异常行为自我诊断

### Claude 自检清单

每当检测到异常行为，Claude 应该执行自检：

#### 检查项 1：任务目标清晰吗？

```
□ 我是否完全理解用户的需求？
□ Contract 是否明确定义了目标？
□ 是否存在模糊或矛盾的要求？

如果不清晰 → 停止，询问用户
```

#### 检查项 2：是否使用了正确的工具？

```
□ Read 还是 Grep？（精确 vs 搜索）
□ Glob 还是手动列举？（模式匹配 vs 已知路径）
□ Coder 还是 Claude 自己？（批量 vs 精细）

如果工具选择不当 → 切换工具
```

#### 检查项 3：是否陷入了无效循环？

```
□ 是否连续失败但没有改变策略？
□ 是否重复执行相同操作期待不同结果？
□ 是否在没有新信息的情况下重复分析？

如果是 → 停止，请求人工介入
```

#### 检查项 4：资源使用是否合理？

```
□ 是否读取了过多文件？
□ 是否执行了过多搜索？
□ 是否调用了过多工具？

如果过度 → 优化策略或询问用户
```

---

## 超时监控和日志

### 实时监控

Claude 应该在任务执行时主动监控：

```
任务开始
    ↓
每 30 秒检查一次：
  - 执行时间
  - 是否有进展
  - 是否重复操作
    ↓
如果接近阈值
    ↓
向用户报告进度
```

### 超时日志格式

记录到 `.ccg/timeout_log.jsonl`：

```jsonl
{"timestamp": "2026-01-21T14:00:00Z", "type": "task_timeout", "agent": "coder", "task": "generate_auth", "duration": 125, "threshold": 120, "action": "warning"}
{"timestamp": "2026-01-21T14:10:00Z", "type": "task_timeout", "agent": "coder", "task": "generate_auth", "duration": 610, "threshold": 600, "action": "terminated"}
{"timestamp": "2026-01-21T14:15:00Z", "type": "decision_timeout", "behavior": "repeated_reads", "file": "src/main.py", "count": 5, "action": "stopped"}
{"timestamp": "2026-01-21T14:20:00Z", "type": "decision_timeout", "behavior": "consecutive_failures", "tool": "coder", "count": 3, "action": "stopped"}
```

---

## 用户干预接口

### 用户可以主动中断

**命令**：
```
用户："停止当前任务"
Claude：立即终止正在执行的 Agent，报告当前状态
```

**命令**：
```
用户："这个任务卡住了吗？"
Claude：报告任务执行时间、当前状态、是否正常
```

**命令**：
```
用户："显示执行日志"
Claude：返回 Agent 的实时输出（最后 50 行）
```

### 用户可以调整超时

**临时调整**：
```
用户："这个任务可能需要 20 分钟，延长超时"
Claude：确认，将当前任务的 max_timeout 调整为 1200 秒
```

**永久调整**：
```
用户："以后 Coder 任务默认 5 分钟超时"
Claude：更新 .ccg/user_preferences.json，设置 coder_default=300
```

---

## 预防性措施

### 任务复杂度预估

在调用 Coder/Codex/Gemini 前，Claude 应该评估：

```
任务复杂度评估
    ↓
┌─────────────────────┐
│ 影响文件数？         │
│ 代码行数？           │
│ 是否涉及架构变更？   │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 复杂度等级？         │
└─────────────────────┘
    ↓
┌────┬────┬────┐
│简单│中等│复杂│
└────┴────┴────┘
  ↓    ↓    ↓
默认  延长  拆分
超时  超时  任务
```

**复杂度判断规则**：

| 复杂度 | 文件数 | 代码行数 | 架构变更 | 建议超时 |
|-------|-------|---------|---------|---------|
| 简单 | 1-2 | < 200 | 否 | 2 分钟 |
| 中等 | 3-5 | 200-1000 | 否 | 5 分钟 |
| 复杂 | > 5 | > 1000 | 是 | 拆分任务 |

### 主动进度报告

对于预计超过 5 分钟的任务，Claude 应该：

```
任务开始
    ↓
向用户说明：
  - 预计执行时间：8 分钟
  - 将每 2 分钟报告一次进度
    ↓
执行中（每 2 分钟）
    ↓
报告：
  - 已执行 2 分钟
  - 当前阶段：生成认证模块
  - 预计剩余：6 分钟
```

---

## 相关文档

- **决策框架**：`decision_framework.md`（总体流程）
- **决策权限**：`decision_authority_matrix.md`（权限等级）
- **错误分类**：`error-handling/error_classification.md`
- **重试策略**：`error-handling/retry_strategy.md`
- **测试修复**：`testing/test_failure_auto_fix.md`

---

## 快速参考

### 超时阈值速查

| Agent | 默认 | 最大 | 警告时机 |
|-------|------|------|---------|
| Coder | 2 min | 10 min | > 2 min |
| Codex | 2 min | 5 min | > 2 min |
| Gemini | 2 min | 8 min | > 2 min |

### 异常行为速查

| 异常行为 | 阈值 | 触发动作 |
|---------|------|---------|
| 重复读文件 | 5 次 | 警告并停止 |
| 连续失败 | 3 次 | 强制停止 |
| 无进展 | 10 min | 进度检查 |
| 过度搜索 | 20 次 | 优化建议 |

### Claude 自检口诀

```
遇到异常 → 停下来 → 自检 4 项 → 调整策略 → 继续或询问
```
