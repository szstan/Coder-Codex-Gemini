# CCG 自动降级策略

> **用途**：当主要 AI 服务不可用时，自动切换到备用方案，确保任务连续性

## 概述

CCG 系统依赖多个 AI 服务（Coder、Codex、Gemini）。当某个服务出现故障、额度不足或响应超时时，需要自动降级到备用方案，避免任务中断。

---

## 降级触发条件

### 触发场景

| 服务 | 触发条件 | 错误类型 | 降级方案 |
|------|---------|---------|---------|
| **Codex** | API 额度不足 | `api_quota_exceeded` | → Coder 审核（降低标准） |
| **Codex** | 认证失败 | `auth_failure` | → Coder 审核 或 Claude 自审 |
| **Codex** | 超时（连续 3 次） | `timeout` | → Coder 审核 |
| **Codex** | 服务不可用 | `service_unavailable` | → Coder 审核 或 跳过审核 |
| **Gemini** | API 不可用 | `api_error` | → Codex + Coder 组合 |
| **Gemini** | 认证失败 | `auth_failure` | → Coder 执行 |
| **Gemini** | 超时（连续 2 次） | `timeout` | → Coder 执行 |
| **Coder** | API 不可用 | `api_error` | → Claude 亲自执行 |
| **Coder** | 超时（连续 3 次） | `timeout` | → 拆分任务或 Claude 执行 |

---

## Codex 降级策略

### 场景 1：Codex API 额度不足

**检测**：
```
调用 mcp__ccg__codex 返回：
{
  "success": false,
  "error_kind": "api_quota_exceeded",
  "error": "API quota exceeded"
}
```

**降级流程**：

```
Codex API 额度不足
    ↓
┌─────────────────────────────────┐
│ 判断任务类型                      │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 是代码审核任务？                  │
└─────────────────────────────────┘
    ↓ 是              ↓ 否
降级到 Coder 审核   Claude 自审
    ↓                  ↓
调整审核标准        降低要求
```

**降级方案 1：使用 Coder 审核（推荐）**

**调整策略**：
- 降低审核标准（快速检查关键问题）
- 缩小审核范围（只审核核心文件）
- 使用简化的 Prompt

**Prompt 调整示例**：

**原始 Codex Prompt**（完整审核）：
```
请全面审核以下代码改动：

**改动文件**：src/auth.py, src/user.py, tests/test_auth.py
**改动目的**：实现用户认证功能

**请检查**：
1. 代码质量（可读性、可维护性）
2. 潜在 Bug 或边界情况
3. 需求完成度
4. 安全性问题
5. 性能优化建议
6. 测试覆盖率

**请给出明确结论**：
- ✅ 通过
- ⚠️ 建议优化
- ❌ 需要修改
```

**降级后 Coder Prompt**（快速检查）：
```
快速检查以下代码改动的关键问题：

**改动文件**：src/auth.py, src/user.py
**改动目的**：实现用户认证功能

**请快速检查**：
1. 是否有明显的语法错误或逻辑错误？
2. 是否实现了基本的认证功能？
3. 是否存在严重的安全漏洞（如明文密码）？

**只需给出简短结论**：
- ✅ 基本合格
- ❌ 发现严重问题（列出）
```

**降级方案 2：Claude 自审（备选）**

**适用**：Coder 也不可用时

**Claude 执行**：
1. 使用 Read 工具读取改动的文件
2. 快速检查明显问题
3. 使用 `claude_review_checklist.md` 进行基本验收

**降级报告**：
```
🔵 Codex 服务降级通知

**原因**：Codex API 额度不足

**降级方案**：使用 Coder 进行快速审核
- 审核标准：从"全面审核"降级为"快速检查"
- 审核范围：仅核心文件（排除测试文件）
- 审核深度：仅检查严重问题

**降级影响**：
- ✅ 任务可以继续执行
- ⚠️ 审核质量有所降低
- ⚠️ 可能漏掉一些优化建议

**建议**：任务完成后，等 Codex 额度恢复，再进行完整审核。

是否继续使用降级方案？
```

### 场景 2：Codex 认证失败

**检测**：
```
{
  "success": false,
  "error_kind": "auth_failure",
  "error": "Invalid API token"
}
```

**降级流程**：

```
Codex 认证失败
    ↓
┌─────────────────────────────────┐
│ 判断是否可修复                    │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 配置错误（可修复）？              │
└─────────────────────────────────┘
    ↓ 是              ↓ 否
提示用户修复配置   降级方案
    ↓
等待修复
```

**降级方案**：
1. **优先**：提示用户检查配置
2. **如果紧急**：降级到 Coder 审核或 Claude 自审
3. **记录降级事件**：保存到 `.ccg/degradation_log.jsonl`

**用户提示**：
```
❌ Codex 认证失败

**错误信息**：Invalid API token

**可能原因**：
1. OpenAI API token 未配置或过期
2. Token 权限不足
3. 配置文件路径错误

**修复指令**：
1. 检查配置文件：~/.ccg-mcp/config.toml
2. 验证 API token 是否正确
3. 确认 token 未过期

**紧急降级方案**：
如果现在无法修复配置，我可以使用 Coder 进行快速审核（质量降低）。

是否使用降级方案？或者您希望先修复配置？
```

### 场景 3：Codex 连续超时

**检测**：
```
连续 3 次调用 Codex 超时（> 5 分钟）
```

**降级流程**：

```
Codex 连续超时 3 次
    ↓
┌─────────────────────────────────┐
│ 判断超时原因                      │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 网络问题 or API 过载？            │
└─────────────────────────────────┘
    ↓ 是              ↓ 否
自动降级          提示用户
    ↓
使用 Coder 审核
```

**降级报告**：
```
⚠️ Codex 连续超时，自动降级

**超时记录**：
- 第 1 次：14:00（5 分 12 秒后超时）
- 第 2 次：14:06（5 分 08 秒后超时）
- 第 3 次：14:12（5 分 15 秒后超时）

**分析**：可能是 Codex API 服务过载或网络问题

**降级方案**：使用 Coder 进行快速审核

**降级影响**：审核质量降低，但任务可以继续

已自动切换到降级方案，继续执行任务。
```

---

## Gemini 降级策略

### 场景 1：Gemini API 不可用

**检测**：
```
调用 mcp__ccg__gemini 返回：
{
  "success": false,
  "error_kind": "api_error",
  "error": "Gemini API unavailable"
}
```

**降级流程（按任务类型）**：

```
Gemini API 不可用
    ↓
┌─────────────────────────────────┐
│ 判断任务类型                      │
└─────────────────────────────────┘
    ↓
┌────────────┬────────────┐
│ 前端/UI 任务│ 其他任务    │
└────────────┴────────────┘
    ↓              ↓
前端降级方案   通用降级方案
```

#### 降级方案 1：前端/UI 任务（推荐 Codex + Coder）

**策略**：
1. **Codex 提供架构指导**（只读，快）
2. **Coder 执行实现**（基于 Codex 指导）

**流程**：
```
Gemini 不可用（前端任务）
    ↓
调用 Codex：请提供前端实现方案
    ↓
获取 Codex 的架构建议
    ↓
调用 Coder：按 Codex 建议实现
    ↓
Claude 验收
```

**Codex Prompt 示例**：
```
请为以下前端需求提供实现方案（仅架构指导，不写代码）：

**需求**：实现用户登录页面（React）

**请提供**：
1. 组件结构建议（哪些组件、如何组织）
2. 状态管理方案（useState / Redux）
3. API 调用策略
4. 表单验证方案

只需要架构建议，不需要完整代码。
```

**Coder Prompt 示例**：
```
根据以下架构建议，实现用户登录页面：

**架构建议**（来自 Codex）：
[Codex 返回的建议...]

**实现要求**：
1. 按照建议的组件结构实现
2. 使用建议的状态管理方案
3. 确保代码符合 React 最佳实践
```

#### 降级方案 2：通用任务（使用 Coder）

**策略**：直接使用 Coder 执行

**流程**：
```
Gemini 不可用（通用任务）
    ↓
调用 Coder：执行原始任务
    ↓
Claude 验收
```

#### 降级方案 3：Claude 亲自执行（最后备选）

**适用**：Coder 也不可用 或 任务简单

**Claude 执行**：
1. 使用 Edit/Write 工具直接修改代码
2. 使用 Bash 工具执行测试
3. 自我验收

**降级报告**：
```
🔵 Gemini 服务降级通知

**原因**：Gemini API 不可用

**任务类型**：前端页面实现

**降级方案**：Codex 提供架构指导 + Coder 执行实现
- 第 1 步：Codex 提供 React 组件结构建议
- 第 2 步：Coder 基于建议实现代码
- 第 3 步：Claude 验收

**降级影响**：
- ✅ 任务可以继续执行
- ⚠️ 可能缺少 Gemini 的前端专业优化
- ⚠️ UI/UX 细节可能不如 Gemini 精细

是否继续使用降级方案？
```

### 场景 2：Gemini 连续超时

**检测**：
```
连续 2 次调用 Gemini 超时（> 8 分钟）
```

**降级流程**：
```
Gemini 连续超时 2 次
    ↓
自动降级到 Coder
    ↓
记录降级事件
    ↓
继续任务
```

---

## Coder 降级策略

### 场景 1：Coder API 不可用

**检测**：
```
调用 mcp__ccg__coder 返回：
{
  "success": false,
  "error_kind": "api_error"
}
```

**降级流程**：

```
Coder API 不可用
    ↓
┌─────────────────────────────────┐
│ 判断任务复杂度                    │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 简单任务（< 3 文件）？            │
└─────────────────────────────────┘
    ↓ 是              ↓ 否
Claude 亲自执行   停止任务
    ↓                  ↓
使用 Edit/Write   等待服务恢复
```

**降级方案 1：Claude 亲自执行（简单任务）**

**适用**：
- 修改文件 ≤ 3 个
- 代码改动 < 100 行
- 逻辑清晰、无需复杂推理

**Claude 执行**：
1. 使用 Edit 工具修改代码
2. 使用 Bash 工具运行测试
3. 自我验收（参考 `claude_review_checklist.md`）

**降级方案 2：停止任务（复杂任务）**

**适用**：
- 修改文件 > 3 个
- 代码改动 > 100 行
- 涉及架构变更

**停止报告**：
```
❌ Coder 服务不可用，任务无法继续

**原因**：Coder API 错误

**任务复杂度**：高（需要修改 8 个文件）

**降级限制**：
- Claude 可以处理简单任务（≤ 3 个文件）
- 当前任务超出 Claude 直接执行能力

**建议**：
1. 等待 Coder 服务恢复
2. 或者拆分任务为多个小任务，让 Claude 逐个执行

请选择：等待服务恢复 或 拆分任务？
```

### 场景 2：Coder 连续超时

**检测**：
```
连续 3 次调用 Coder 超时（> 10 分钟）
```

**降级流程**：

```
Coder 连续超时 3 次
    ↓
┌─────────────────────────────────┐
│ 分析超时原因                      │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 任务太复杂？                      │
└─────────────────────────────────┘
    ↓ 是              ↓ 否
拆分任务          等待或降级
    ↓                  ↓
分解为小任务      Claude 执行
```

---

## 降级记录和监控

### 降级日志格式

所有降级事件记录到 `.ccg/degradation_log.jsonl`：

```jsonl
{"timestamp": "2026-01-21T14:00:00Z", "service": "codex", "reason": "api_quota_exceeded", "fallback": "coder_review", "task": "code_review", "impact": "lower_quality"}
{"timestamp": "2026-01-21T14:15:00Z", "service": "gemini", "reason": "api_unavailable", "fallback": "codex_coder_combo", "task": "frontend_implementation", "impact": "reduced_ui_optimization"}
{"timestamp": "2026-01-21T14:30:00Z", "service": "coder", "reason": "timeout", "fallback": "claude_manual", "task": "simple_fix", "impact": "slower_execution"}
```

### 降级统计

定期分析降级日志，生成统计报告：

```
降级统计报告（最近 7 天）

**Codex 降级**：
- 总次数：15 次
- 主要原因：api_quota_exceeded（12 次）、timeout（3 次）
- 降级方案：coder_review（12 次）、claude_self_review（3 次）

**Gemini 降级**：
- 总次数：5 次
- 主要原因：api_unavailable（5 次）
- 降级方案：codex_coder_combo（5 次）

**Coder 降级**：
- 总次数：2 次
- 主要原因：timeout（2 次）
- 降级方案：claude_manual（2 次）

**建议**：
- Codex 额度不足频繁，建议升级 API 套餐
- Gemini 偶尔不可用，当前降级方案有效
- Coder 超时较少，系统整体稳定
```

---

## 降级策略配置

### 全局配置

在 `.ccg/user_preferences.json` 中配置：

```json
{
  "degradation": {
    "auto_degrade": true,           // 是否自动降级
    "notify_user": true,            // 降级时是否通知用户
    "codex_fallback": "coder_review",  // Codex 降级方案
    "gemini_fallback": "codex_coder",  // Gemini 降级方案
    "coder_fallback": "claude_manual", // Coder 降级方案
    "max_degradation_level": 2      // 最大降级层级（防止过度降级）
  }
}
```

### 降级层级

```
层级 0（正常）：使用主要服务
    ↓ 降级
层级 1（轻度降级）：使用备用 AI
    ↓ 降级
层级 2（中度降级）：Claude 亲自执行
    ↓ 降级
层级 3（重度降级）：停止任务，等待人工
```

**最大降级层级限制**：
- `max_degradation_level = 1`：只允许备用 AI，不允许 Claude 手动
- `max_degradation_level = 2`：允许 Claude 手动，但不停止任务
- `max_degradation_level = 3`：允许所有降级方案

---

## 降级策略决策树

```
服务调用失败
    ↓
┌─────────────────────────────────┐
│ 识别失败服务和原因                │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 失败服务？                        │
└─────────────────────────────────┘
    ↓
┌────────┬────────┬────────┐
│ Codex  │ Gemini │ Coder  │
└────────┴────────┴────────┘
    ↓        ↓        ↓

【Codex 降级分支】
    ↓
┌─────────────────────────┐
│ 失败原因？               │
└─────────────────────────┘
    ↓
┌──────┬──────┬──────┐
│额度  │认证  │超时  │
└──────┴──────┴──────┘
  ↓      ↓      ↓
Coder  提示  Coder
审核   用户  审核

【Gemini 降级分支】
    ↓
┌─────────────────────────┐
│ 任务类型？               │
└─────────────────────────┘
    ↓
┌──────────┬──────────┐
│ 前端/UI  │ 其他     │
└──────────┴──────────┘
    ↓          ↓
Codex+Coder  Coder执行

【Coder 降级分支】
    ↓
┌─────────────────────────┐
│ 任务复杂度？             │
└─────────────────────────┘
    ↓
┌──────────┬──────────┐
│ 简单     │ 复杂     │
└──────────┴──────────┘
    ↓          ↓
Claude手动  停止任务
```

---

## 相关文档

- **决策框架**：`decision_framework.md`（总体流程）
- **决策权限**：`decision_authority_matrix.md`（权限等级）
- **错误分类**：`error_classification.md`（错误类型）
- **重试策略**：`retry_strategy.md`（重试逻辑）
- **超时机制**：`timeout_guardrails.md`（超时处理）

---

## 快速参考

### 降级方案速查

| 失败服务 | 主要原因 | 推荐降级方案 | 质量影响 |
|---------|---------|------------|---------|
| Codex | 额度不足 | Coder 审核 | 中等 ⚠️ |
| Codex | 认证失败 | 提示修复 | - |
| Codex | 超时 | Coder 审核 | 中等 ⚠️ |
| Gemini | 不可用（前端） | Codex + Coder | 较小 ✅ |
| Gemini | 不可用（其他） | Coder 执行 | 较小 ✅ |
| Coder | 不可用（简单） | Claude 手动 | 较小 ✅ |
| Coder | 不可用（复杂） | 停止任务 | 无法继续 ❌ |

### Claude 降级决策口诀

```
服务失败 → 识别原因 → 选择降级方案 → 通知用户 → 记录日志 → 继续任务
```
