# 自适应重试策略

## 概述

自适应重试策略根据错误类型和历史重试记录，动态调整重试次数、重试间隔和重试条件，以提高任务成功率并避免资源浪费。

## 核心原则

1. **智能判断**：只对可恢复的错误进行重试
2. **指数退避**：重试间隔逐渐增加，避免过度请求
3. **上下文保持**：重试时保持 SESSION_ID 和执行上下文
4. **资源保护**：设置最大重试次数，避免无限循环

## 重试策略矩阵

### 按错误类型分类

| 错误类型 | 是否重试 | 最大重试次数 | 退避策略 | SESSION_ID |
|---------|---------|------------|---------|-----------|
| 临时性错误 | ✅ 是 | 3-5 次 | 指数退避 | 保持 |
| 代码错误 | ❌ 否 | 0 | - | - |
| 环境错误 | ❌ 否 | 0 | - | - |
| 不可恢复错误 | ❌ 否 | 0 | - | - |

### 按 Agent 类型分类

| Agent | 默认重试次数 | 可配置 | 说明 |
|-------|------------|-------|------|
| Coder | 0 | ✅ 是 | 有写入副作用，默认不重试 |
| Codex | 1 | ✅ 是 | 只读操作，默认允许 1 次重试 |
| Gemini | 1 | ✅ 是 | 默认允许 1 次重试 |

## 指数退避算法

### 基本公式

```
等待时间 = base_delay × (2 ^ retry_count) + random_jitter

其中：
- base_delay: 基础延迟（默认 1 秒）
- retry_count: 当前重试次数（从 0 开始）
- random_jitter: 随机抖动（0-1 秒），避免同时重试
```

### 退避时间表

| 重试次数 | 等待时间 | 累计时间 |
|---------|---------|---------|
| 第 1 次 | 1-2 秒 | 1-2 秒 |
| 第 2 次 | 2-3 秒 | 3-5 秒 |
| 第 3 次 | 4-5 秒 | 7-10 秒 |
| 第 4 次 | 8-9 秒 | 15-19 秒 |
| 第 5 次 | 16-17 秒 | 31-36 秒 |

## 重试决策流程

```
任务执行失败
    ↓
错误分类（参考 error_classification.md）
    ↓
┌─────────────────────────┐
│ 是否为临时性错误？        │
└─────────────────────────┘
    ↓ 否                ↓ 是
停止，提供修复建议    检查重试次数
    ↓
┌─────────────────────────┐
│ 是否达到最大重试次数？    │
└─────────────────────────┘
    ↓ 是                ↓ 否
停止，报告失败        计算等待时间
    ↓
等待（指数退避）
    ↓
重试（保持 SESSION_ID）
```

## 使用指南

### Claude 如何执行重试

**步骤 1：错误分类**
```
1. 捕获 MCP 工具返回的错误信息
2. 使用 error_classification.md 中的规则分类
3. 判断是否为临时性错误
```

**步骤 2：重试决策**
```
如果是临时性错误：
  - 检查当前重试次数
  - 如果未达到最大次数，继续重试
  - 否则，停止并报告
```

**步骤 3：计算等待时间**
```
wait_time = 1 × (2 ^ retry_count) + random(0, 1)
例如：第 2 次重试 = 1 × 4 + 0.5 = 4.5 秒
```

**步骤 4：执行重试**
```
1. 向用户报告：正在重试（第 X/Y 次），等待 Z 秒
2. 等待指定时间
3. 使用相同的 SESSION_ID 重新调用 MCP 工具
4. 传递相同的参数和上下文
```

### 重试示例

**示例：网络超时重试**
```
第 1 次执行：失败（network_timeout）
  ↓
分类：临时性错误，可重试
  ↓
第 1 次重试：等待 2 秒
  ↓
第 2 次执行：失败（network_timeout）
  ↓
第 2 次重试：等待 4 秒
  ↓
第 3 次执行：成功 ✅
```

## 注意事项

### 重试的限制

1. **不要对代码错误重试**
   - 语法错误、类型错误等不会因为重试而解决
   - 应该提供修复建议，等待用户修复

2. **保持 SESSION_ID**
   - 重试时必须使用相同的 SESSION_ID
   - 保持对话上下文的连续性

3. **避免无限重试**
   - 设置合理的最大重试次数（3-5 次）
   - 超过最大次数后停止并报告

4. **向用户报告进度**
   - 每次重试前告知用户
   - 说明重试原因和等待时间

## 总结

自适应重试策略通过智能判断和指数退避，提高临时性错误的恢复成功率，同时避免对不可恢复错误的无效重试。
