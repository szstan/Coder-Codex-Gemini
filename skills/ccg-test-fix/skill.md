---
name: ccg:test-fix
description: 测试失败自动修复（单层 Coder 修复，最多 3 次重试）
category: Testing
tags: [test, fix, auto-repair, coder]
---

# 测试失败自动修复

> **用途**：当测试失败时，使用 Coder 进行自动修复（最多 3 次重试）

## 核心原则

1. **安全第一**：最大重试 3 次，避免无限循环
2. **智能分析**：使用错误分类系统判断是否可自动修复
3. **渐进式修复**：每次修复后立即验证，失败则重新分析
4. **人工介入点**：超过最大重试次数后停止，请求人工介入
5. **完整记录**：记录所有修复尝试和结果

## 适用场景判断

### ✅ 可自动修复

- 简单的代码逻辑错误
- 类型错误（类型不匹配、参数类型错误）
- 断言失败（预期值与实际值不匹配）
- 边界条件处理不当
- 返回值错误

### ❌ 不可自动修复

- 架构级问题（需要重新设计、涉及多个模块）
- 环境问题（依赖缺失、配置错误）
- 复杂的业务逻辑错误

## 执行步骤

### 步骤 1：分析失败原因

**读取测试输出**：
- 使用 Read 工具读取测试失败的输出
- 识别失败的测试用例名称
- 提取错误信息和堆栈跟踪

**分析错误类型**：
- 使用 `ai/error-handling/error_classification.md` 分类错误
- 判断是否属于可自动修复的类型

### 步骤 2：判断是否可自动修复

**如果不可自动修复**：
- 停止自动修复流程
- 向用户报告：
  ```
  测试失败原因：[错误类型]
  不适合自动修复，建议：[具体建议]
  ```

**如果可自动修复**：
- 继续执行步骤 3

### 步骤 3：读取相关代码

**读取失败的测试文件**：
- 使用 Read 工具读取测试文件
- 定位失败的测试用例

**读取被测试的源代码**：
- 根据测试文件找到对应的源代码文件
- 使用 Read 工具读取源代码

### 步骤 4：生成修复 Prompt

**Prompt 模板**：
```
请修复以下测试失败：

**测试文件**：[测试文件路径]
**失败的测试用例**：[测试用例名称]
**错误信息**：
[错误信息和堆栈跟踪]

**源代码文件**：[源代码文件路径]

**修复要求**：
1. 只修复导致测试失败的问题
2. 不要修改测试用例本身（除非测试用例有明显错误）
3. 保持代码风格一致
4. 确保修复后测试通过

**验收标准**：
- 测试通过
- 代码逻辑正确
- 没有引入新的问题
```

### 步骤 5：调用 Coder 修复

**调用 MCP 工具**：
- 先调用 `/ccg-workflow` Skill 获取指导
- 调用 `mcp__ccg__coder` 执行修复
- 传递生成的修复 Prompt 和 SESSION_ID

### 步骤 6：验证修复结果

**运行测试**：
- 使用 Bash 工具运行测试命令
- 检查测试是否通过

**如果测试通过**：
- 修复成功，结束流程
- 报告修复结果

**如果测试仍然失败**：
- 继续步骤 7

### 步骤 7：重试控制

**检查重试次数**：
- 如果重试次数 < 3：
  - 重试次数 +1
  - 返回步骤 1（重新分析失败原因）

- 如果重试次数 >= 3：
  - 停止自动修复
  - 向用户报告：
    ```
    自动修复失败（已尝试 3 次）

    **失败原因**：[最后一次的错误信息]
    **建议**：
    1. 检查是否是架构级问题
    2. 检查是否是环境问题
    3. 考虑使用 /ccg:test-fix-advanced（多层级修复）
    ```

## 何时升级到多层级修复

**如果单层修复失败**，强烈建议升级到 `/ccg:test-fix-advanced`（多层级修复）。

### 多层级修复的优势

| 特性 | 单层修复（本 Skill） | 多层级修复（/ccg:test-fix-advanced） |
|------|---------------------|-----------------------------------|
| **修复策略** | 单层 Coder（3次） | 智能诊断 + 3层9次 + 人工介入 |
| **领域分流** | ❌ 无 | ✅ 前端优先Gemini，后端优先Codex |
| **尝试次数** | 3次 | 9次自动 + 人工介入 |
| **成功率** | 60-70% | 100%（自动96-99% + 人工100%） |
| **适用场景** | 简单问题 | 所有问题（简单+复杂） |

### 升级时机

**立即升级**（以下任一情况）：
- ✅ 单层修复 3 次都失败
- ✅ 问题涉及多个文件或模块
- ✅ 问题需要深度理解项目架构
- ✅ 前端/UI 相关问题（Gemini 更擅长）
- ✅ 复杂的后端逻辑问题

**可选升级**：
- 🔧 第一次修复失败，但问题看起来复杂
- 🔧 需要更高的成功率保障

### 升级方法

```
用户："单层修复失败了"
→ Claude："让我使用多层级修复策略"
→ Claude 调用 /ccg:test-fix-advanced
→ 执行智能诊断 + 按领域分流 + 3层9次修复
```

## 使用示例

**调用方式**：
```
用户："测试失败了，帮我修复"
→ Claude 调用 /ccg:test-fix
→ 执行自动修复流程
```

## 相关文档

- 详细文档：`ai/testing/test_failure_auto_fix.md`
- 错误分类：`ai/error-handling/error_classification.md`
- 多层级修复：使用 `/ccg:test-fix-advanced` Skill
