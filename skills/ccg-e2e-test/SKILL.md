# CCG E2E 测试生成 Skill

> **Skill 名称**: `/ccg-e2e-test`
> **版本**: v1.0.0
> **最后更新**: 2026-01-20

---

## 📋 Skill 概述

**用途**：使用 Playwright 为 Web 应用生成端到端（E2E）测试

**核心价值**：
- 自动化生成高质量的 E2E 测试代码
- 集成 CCG 协作流程（Coder 执行 + Codex 审核）
- 支持多种测试场景和最佳实践
- 确保测试覆盖率和可维护性

**适用场景**：
- 为新功能生成 E2E 测试
- 为现有功能补充测试覆盖
- 重构测试代码提升质量
- 生成回归测试套件

---

## 🎯 使用时机

### 必须使用此 Skill 的情况

1. **用户明确要求生成 E2E 测试**
2. **新功能开发完成后需要测试**
3. **前端功能需要自动化测试**
4. **需要生成 Playwright 测试代码**

### 推荐使用此 Skill 的情况

1. 重要的用户流程（登录、注册、支付等）
2. 复杂的 UI 交互（拖拽、动画、表单验证）
3. 跨页面的业务流程
4. 需要回归测试的功能

---

## 📖 完整工作流程

### 阶段 1：需求分析（Claude 执行）

**目标**：理解测试需求，识别测试场景

**步骤**：
1. 与用户确认测试目标
2. 识别关键测试场景
3. 确定技术栈和测试框架
4. 规划测试文件结构

**输出**：测试需求文档

**示例**：
```markdown
## 测试需求：用户登录功能

### 测试场景
1. 正常登录流程
2. 错误密码处理
3. 空字段验证
4. 记住我功能

### 技术栈
- 前端：React + TypeScript
- 测试框架：Playwright Test
- 页面 URL：https://example.com/login

### 测试文件结构
- tests/e2e/login.spec.ts
- tests/pages/LoginPage.ts
```

---

### 阶段 2：生成测试代码（Coder 执行）

**目标**：生成高质量的 Playwright 测试代码

**执行方式**：调用 `mcp__ccg__coder`

**Prompt 模板**：
```
请使用 Playwright 为以下功能生成 E2E 测试：

**功能描述**：[功能名称]
**页面 URL**：[URL]
**技术栈**：[前端框架]

**测试场景**：
1. [场景 1]
2. [场景 2]
3. [场景 3]

**技术要求**：
1. 使用 Playwright Test 框架
2. 使用 Page Object Model 模式
3. 使用 data-testid 选择器（优先）
4. 包含适当的等待和断言
5. 包含错误处理和失败截图
6. 添加清晰的注释

**文件结构**：
- tests/e2e/[feature].spec.ts - 测试用例
- tests/pages/[Feature]Page.ts - Page Object

**验收标准**：
- 所有测试场景覆盖
- 代码可读性良好
- 遵循 Playwright 最佳实践
- 包含必要的注释
```

**输出**：测试代码文件

---

### 阶段 3：Claude 验收

**目标**：快速检查测试代码质量

**检查清单**：
- [ ] 测试文件结构正确
- [ ] 所有测试场景已覆盖
- [ ] 使用了 Page Object Model
- [ ] 选择器策略合理（优先 data-testid）
- [ ] 包含适当的断言
- [ ] 代码风格符合规范
- [ ] 包含必要的注释

**如果发现问题**：
- 简单问题：Claude 直接修复
- 复杂问题：重新调用 Coder 修复

---

### 阶段 4：Codex 审核

**目标**：深度审核测试质量

**执行方式**：调用 `mcp__ccg__codex`

**Codex Prompt 模板**：
```
请审核以下 Playwright E2E 测试代码：

**审核维度**：
1. **测试覆盖率**：是否覆盖所有关键场景？
2. **断言质量**：断言是否充分且合理？
3. **选择器策略**：是否使用稳定的选择器？
4. **等待策略**：是否正确处理异步操作？
5. **测试隔离**：测试之间是否独立？
6. **错误处理**：是否有失败截图和日志？
7. **可维护性**：代码是否清晰易维护？
8. **最佳实践**：是否遵循 Playwright 最佳实践？

**请给出明确结论**：
- ✅ 通过：测试质量良好，可以合入
- ⚠️ 建议优化：[具体建议]
- ❌ 需要修改：[具体问题]
```

**审核结果处理**：
- ✅ 通过：进入下一阶段
- ⚠️ 建议优化：记录建议，可选择性优化
- ❌ 需要修改：调用 Coder 修复，重新审核

---

### 阶段 5：执行测试（Claude 执行）

**目标**：验证测试可以正常运行

**步骤**：
1. 安装依赖（如需要）
2. 运行测试：`npx playwright test`
3. 检查测试结果
4. 如有失败，分析原因并修复

**成功标准**：
- 所有测试通过
- 无 flaky tests
- 执行时间合理

---

## 🔄 完整流程图

```
用户提出需求
    ↓
阶段 1: Claude 分析需求（5-10 分钟）
    ├─ 识别测试场景
    ├─ 确定技术栈
    └─ 规划文件结构
    ↓
阶段 2: Coder 生成测试代码（10-20 分钟）
    ├─ 生成测试用例
    ├─ 生成 Page Object
    └─ 添加注释和文档
    ↓
阶段 3: Claude 验收（5-10 分钟）
    ├─ 检查文件结构
    ├─ 验证场景覆盖
    └─ 修复简单问题
    ↓
阶段 4: Codex 审核（10-15 分钟）
    ├─ 深度质量审核
    ├─ 给出明确结论
    └─ 如需修改，返回阶段 2
    ↓
阶段 5: Claude 执行测试（5-10 分钟）
    ├─ 运行测试
    ├─ 验证结果
    └─ 修复失败（如有）
    ↓
完成 ✅
```

**总耗时**：约 35-65 分钟

---

## 📝 使用示例

### 示例 1：为登录功能生成测试

**用户请求**：
```
请为登录功能生成 E2E 测试
```

**Claude 执行**：
```
1. 分析需求：
   - 测试场景：正常登录、错误密码、空字段验证
   - 技术栈：React + TypeScript
   - 文件结构：tests/e2e/login.spec.ts, tests/pages/LoginPage.ts

2. 调用 Coder 生成测试代码

3. 验收检查：
   - ✅ 文件结构正确
   - ✅ 场景覆盖完整
   - ✅ 使用 Page Object Model
   - ✅ 选择器使用 data-testid

4. 调用 Codex 审核
   - Codex 结论：✅ 通过

5. 执行测试
   - 运行：npx playwright test tests/e2e/login.spec.ts
   - 结果：3 passed (5.2s)

完成！测试代码已生成并验证通过。
```

### 示例 2：为购物车功能生成测试

**用户请求**：
```
请为购物车功能生成完整的 E2E 测试，包括添加商品、修改数量、删除商品、结算流程
```

**Claude 执行**：
```
1. 分析需求：
   - 测试场景：添加商品、修改数量、删除商品、结算流程、空购物车处理
   - 技术栈：Vue 3 + TypeScript
   - 文件结构：
     - tests/e2e/cart.spec.ts
     - tests/pages/CartPage.ts
     - tests/pages/ProductPage.ts
     - tests/pages/CheckoutPage.ts

2. 调用 Coder 生成测试代码（包含 3 个 Page Object 和 1 个测试文件）

3. 验收检查：
   - ✅ 所有场景覆盖
   - ✅ Page Object 结构清晰
   - ⚠️ 发现问题：缺少购物车为空的边界测试
   - 修复：添加空购物车测试用例

4. 调用 Codex 审核
   - Codex 结论：⚠️ 建议优化
   - 建议：添加商品数量验证的断言
   - 处理：采纳建议，调用 Coder 优化

5. 执行测试
   - 运行：npx playwright test tests/e2e/cart.spec.ts
   - 结果：5 passed (12.8s)

完成！购物车测试套件已生成并验证通过。
```

---

## ⚠️ 注意事项

### 1. 选择器策略

**强制要求**：
- ✅ 优先使用 `data-testid` 属性
- ✅ 其次使用 `aria-label` 或 `role` 属性
- ⚠️ 谨慎使用文本选择器（可能因国际化变化）
- ❌ 避免使用 CSS 类名（容易变化）

### 2. 测试隔离

**强制要求**：
- 每个测试必须独立运行
- 使用 `beforeEach` 重置状态
- 不依赖其他测试的执行顺序

### 3. 异步处理

**强制要求**：
- 依赖 Playwright 的自动等待机制
- 特殊情况使用 `waitForResponse` 或 `waitForSelector`
- 避免使用固定时间的 `sleep`

### 4. 错误处理

**强制要求**：
- 测试失败时自动截图
- 记录控制台错误日志
- 提供清晰的失败信息

---

## 🔧 故障排查

### 问题 1：Coder 生成的测试代码不符合预期

**解决方案**：
1. 检查 Prompt 是否足够详细
2. 补充具体的技术要求和示例
3. 重新调用 Coder 生成

### 问题 2：Codex 审核不通过

**解决方案**：
1. 仔细阅读 Codex 的反馈
2. 根据反馈调用 Coder 修复
3. 如果是误判，与用户确认后可忽略

### 问题 3：测试执行失败

**解决方案**：
1. 检查选择器是否正确
2. 检查页面 URL 是否可访问
3. 检查是否需要登录状态
4. 查看截图和控制台日志定位问题

---

## 📚 相关资源

- [Playwright 使用指南](../../docs/PLAYWRIGHT_GUIDE.md)
- [测试策略文档](../../ai/testing_strategy.md)
- [CCG 工作流](../ccg-workflow/SKILL.md)
- [Playwright 官方文档](https://playwright.dev)

---

## 🎯 成功标准

完成此 Skill 后，应该达到以下标准：

- ✅ 测试代码已生成并通过 Codex 审核
- ✅ 所有测试场景已覆盖
- ✅ 测试可以正常运行并通过
- ✅ 代码遵循 Playwright 最佳实践
- ✅ 使用 Page Object Model 模式
- ✅ 包含适当的注释和文档

---

**最后更新**: 2026-01-20
**维护者**: CCG Team
