---
name: ccg:test-fix-advanced
description: 测试失败多层级修复（智能诊断 + 3层9次 + 人工介入，100%解决）
category: Testing
tags: [test, fix, multi-tier, advanced, human-in-loop]
---

# 测试失败多层级修复策略

> **用途**：使用智能诊断 + 多层级修复 + 人工介入，实现 100% 问题解决率

## 核心思想

充分利用 CCG 系统中所有 AI 的能力，通过智能诊断、3 层自动修复（每层 3 次重试）和人工介入，实现真正的 100% 问题解决率。

## 修复策略概述

```
测试失败
  ↓
步骤 0：智能诊断（1-2 分钟）
  - 分析失败类型
  - 收集相关上下文
  - 确认需求理解
  ↓
简单问题（80%）→ 自动修复流程
复杂问题（20%）→ 直接人工介入
  ↓
第 1 层：Codex 深度诊断 + Coder 执行（最多 3 次）
  ↓ 失败
第 2 层：Claude 亲自动手修复（最多 3 次）
  ↓ 失败
第 3 层：Gemini 独立视角修复（最多 3 次）
  ↓ 失败
第 4 层：人工介入（5 分钟超时）
  - 5 分钟内响应 → 人工解决 → 100%
  - 5 分钟无响应 → 记录并跳过 → 继续其他任务
```

**总修复尝试次数**：9 次自动 + 人工介入
**预期成功率**：100%（自动 96-99% + 人工 100%）

## acemcp 语义搜索集成

在每层修复前，使用 `mcp__acemcp__search_context` 进行语义搜索：

**核心优势**：
- 语义理解：不只是关键词匹配，理解代码的语义关系
- 自动索引：搜索前自动增量更新索引
- 全面覆盖：找到所有相关代码，包括辅助函数、工具类

**使用场景**：
- 步骤 0：智能诊断时的初步搜索
- 第 1 层：深度搜索相关概念和模式
- 第 2 层：全面理解项目架构
- 第 3 层：独立视角的语义搜索

## 步骤 0：智能诊断（前置步骤）

**目的**：快速判断问题类型，避免浪费时间在错误方向上

**执行时间**：1-2 分钟

### 诊断步骤

**步骤 1：分析失败类型**
```python
# 简单问题特征
simple_patterns = [
    "SyntaxError",           # 语法错误
    "NameError",             # 变量名错误
    "TypeError",             # 类型错误
    "AttributeError",        # 属性错误
    "简单的 AssertionError"  # 简单断言失败
]

# 复杂问题特征
complex_patterns = [
    "多个测试同时失败",      # 架构级问题
    "测试逻辑可能有问题",    # 测试本身错误
    "需要大规模重构",        # 设计问题
    "缺少关键业务知识"       # 需求理解问题
]
```

**步骤 2：收集相关上下文**
- 读取测试文件和源代码
- 使用 acemcp 初步搜索相关代码
- 读取相关文档（如果存在）

**步骤 3：确认需求理解**
```markdown
## 测试意图理解

我理解这个测试是要验证：
[AI 的理解描述]

**请确认**：
- ✅ 理解正确 → 继续自动修复
- ❌ 理解有误 → 请说明正确意图
- ⚠️ 测试本身可能有问题 → 建议人工审查
```

**步骤 4：决策**
- 简单问题 → 进入自动修复流程（第 1-3 层）
- 复杂问题 → 直接进入第 4 层人工介入

## 第 1 层：Codex 深度诊断 + Coder 执行

**角色**：Codex（诊断）+ Coder（执行）
**尝试次数**：最多 3 次
**预期成功率**：85-90%

### 执行步骤

**步骤 1：使用 acemcp 深度搜索**
```json
{
  "project_root_path": "项目根目录绝对路径",
  "query": "测试失败相关的概念、模式、类似实现"
}
```

**步骤 2：调用 Codex 诊断**
- 调用 `/ccg-workflow` Skill
- 调用 `mcp__ccg__codex` 进行深度分析
- 传递完整上下文：
  - 测试失败信息
  - acemcp 搜索结果
  - 相关代码文件

**步骤 3：Codex 诊断内容**
- 分析根本原因（不只是表面错误）
- 识别架构级问题
- 提供详细修复方案
- 给出具体的代码修改建议

**步骤 4：Coder 执行修复**
- 根据 Codex 的诊断结果
- 调用 `mcp__ccg__coder` 执行修复
- 传递 Codex 的修复方案
- 保持 SESSION_ID 上下文

**步骤 5：验证结果**
- 运行测试
- 如果通过，修复成功
- 如果失败且重试次数 < 3，重新诊断并重试
- 如果失败且重试次数 >= 3，进入第 2 层

## 第 2 层：Claude 亲自动手修复

**角色**：Claude（你自己）
**尝试次数**：最多 3 次
**预期成功率**：+8-12%（累计 93-97%）

### 执行步骤

**步骤 1：使用 acemcp 全面搜索**
```json
{
  "project_root_path": "项目根目录绝对路径",
  "query": "测试失败相关的项目架构、设计模式、完整上下文"
}
```

**步骤 2：深度分析**
- 回顾第 1 层的所有尝试和结果
- 分析为什么 Codex + Coder 都失败了
- 结合 acemcp 搜索结果理解项目架构
- 识别可能的深层次问题

**步骤 3：亲自修复**
- 使用 Edit 工具直接修改代码
- 不依赖 Coder，完全由 Claude 控制
- 可以进行复杂的多文件修改
- 可以重构代码结构

**步骤 4：验证结果**
- 运行测试
- 如果通过，修复成功
- 如果失败且重试次数 < 3，重新分析并重试
- 如果失败且重试次数 >= 3，进入第 3 层

## 第 3 层：Gemini 独立视角修复

**角色**：Gemini（独立专家）
**尝试次数**：最多 3 次
**预期成功率**：+3-5%（累计 96-99%）

### 执行步骤

**步骤 1：准备完整上下文**
- 整理前两层的所有尝试和结果
- 准备测试失败的完整信息
- 准备相关代码文件
- 准备 acemcp 搜索结果

**步骤 2：调用 Gemini**
- 调用 `/gemini-collaboration` Skill
- 调用 `mcp__ccg__gemini` 进行独立分析和修复
- 传递完整上下文和历史尝试

**步骤 3：Gemini 独立视角**
- 不受前面尝试的思维定式影响
- 从全新角度分析问题
- 可能提出完全不同的解决方案
- 直接修改代码（yolo 模式）

**步骤 4：验证结果**
- 运行测试
- 如果通过，修复成功
- 如果失败且重试次数 < 3，重新分析并重试
- 如果失败且重试次数 >= 3，进入第 4 层

## 第 4 层：人工介入（最终保障）

**角色**：人工专家
**超时时间**：5 分钟
**成功率**：100%

### 触发条件

所有 3 层自动修复都失败（共 9 次尝试）

### 执行步骤

**步骤 1：生成人工介入报告**

```markdown
## 🚨 需要人工介入

**测试信息**：
- 测试文件：tests/test_example.py
- 测试用例：test_function_name
- 错误信息：AssertionError: Expected 5, got 3

**自动修复尝试**（已失败 9 次）：
- 第 1 层（Codex + Coder）：3 次尝试，失败
- 第 2 层（Claude）：3 次尝试，失败
- 第 3 层（Gemini）：3 次尝试，失败

**可能原因**：
1. 测试用例本身可能有问题
2. 需要架构级重构
3. 缺少关键业务知识

**详细信息**：
- 失败记录：.ccg/pending_test_fixes.json
- 所有修复尝试的详细日志
- AI 的分析和诊断结果

**请在 5 分钟内响应**：
- ✅ 立即介入 → 人工解决
- ⏰ 5 分钟无响应 → 自动记录并跳过
```

**步骤 2：等待人工响应（5 分钟超时）**

- 启动 5 分钟倒计时
- 等待用户响应

**步骤 3：处理响应**

**情况 A：5 分钟内响应**
- 用户介入解决问题
- 成功率：100%
- 更新状态为"已人工解决"

**情况 B：5 分钟无响应**
- 自动记录到 `.ccg/pending_test_fixes.json`
- 标记状态为"等待人工介入"
- 继续执行其他任务
- 不阻塞整体流程

## 失败记录流程

**触发条件**：第 4 层人工介入超时（5 分钟无响应）

### 记录内容
{
  "pending_fixes": [
    {
      "timestamp": "2026-01-17T10:30:00Z",
      "test_file": "tests/test_example.py",
      "test_name": "test_function_name",
      "error_message": "AssertionError: Expected 5, got 3",
      "error_type": "assertion_failure",
      "source_files": [
        "src/module.py",
        "src/helper.py"
      ],
      "repair_attempts": [
        {
          "tier": 1,
          "agent": "Codex + Coder",
          "attempts": 3,
          "diagnosis": "可能是边界条件处理问题",
          "last_error": "边界条件修复后仍失败"
        },
        {
          "tier": 2,
          "agent": "Claude",
          "attempts": 3,
          "last_error": "重构后仍未解决"
        },
        {
          "tier": 3,
          "agent": "Gemini",
          "attempts": 3,
          "last_error": "独立视角修复后仍失败"
        }
      ],
      "acemcp_searches": [
        "相关功能描述",
        "相关概念和模式",
        "项目架构和设计模式"
      ],
      "human_intervention": {
        "requested_at": "2026-01-17T10:35:00Z",
        "timeout_minutes": 5,
        "status": "pending",
        "responded_at": null,
        "resolution": null
      },
      "suggested_actions": [
        "人工审查测试用例是否正确",
        "检查是否是架构级问题",
        "考虑重新设计该模块"
      ]
    }
  ]
}
```

### 向用户报告

**情况 A：人工介入超时（5 分钟无响应）**
```
🚨 测试修复需要人工介入（已超时）

**测试信息**：
- 测试文件：tests/test_example.py
- 测试用例：test_function_name
- 错误信息：AssertionError: Expected 5, got 3

**自动修复尝试**（已失败 9 次）：
- 第 1 层（Codex + Coder）：3 次尝试，失败
- 第 2 层（Claude）：3 次尝试，失败
- 第 3 层（Gemini）：3 次尝试，失败

**人工介入状态**：
- ⏰ 等待 5 分钟，无响应
- 📝 已记录到待处理列表
- ✅ 继续执行其他任务

**后续操作**：
- 查看详细信息：.ccg/pending_test_fixes.json
- 稍后可批量处理待修复问题
```

**情况 B：人工立即介入**
```
✅ 测试修复已人工解决

**测试信息**：
- 测试文件：tests/test_example.py
- 测试用例：test_function_name

**解决方式**：人工介入
**解决时间**：2 分钟
**成功率**：100%
```

## 使用示例

**调用方式**：
```
用户："测试失败了，单层修复不行，帮我用多层级修复"
→ Claude 调用 /ccg:test-fix-advanced
→ 执行多层级修复流程
```

**典型场景**：
1. `/ccg:test-fix` 修复失败后自动升级
2. 用户明确要求使用多层级修复
3. 复杂的测试失败需要多方协作

## 相关文档

- 详细文档：`ai/testing/test_failure_multi_tier_fix.md`
- 单层修复：使用 `/ccg:test-fix` Skill
- 错误分类：`ai/error-handling/error_classification.md`
- acemcp 搜索：`mcp__acemcp__search_context` 工具

## 注意事项

1. **SESSION_ID 管理**：每个角色的 SESSION_ID 独立，必须使用实际返回值
2. **acemcp 搜索**：每层修复前都应该使用，提高成功率
3. **失败记录**：所有失败信息都会记录到 `.ccg/pending_test_fixes.json`
4. **人工介入**：4 层修复都失败后，需要人工审查

